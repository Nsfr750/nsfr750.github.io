

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>email_duplicate_cleaner &mdash; Email Duplicate Cleaner 2.4.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=4d935f96"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Email Duplicate Cleaner
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">Modules</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Email Duplicate Cleaner</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">email_duplicate_cleaner</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for email_duplicate_cleaner</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Email Duplicate Cleaner</span>

<span class="sd">This script scans email client folders for duplicate messages and provides</span>
<span class="sd">options to safely delete them while preserving originals.</span>

<span class="sd">Currently supported email clients:</span>
<span class="sd">- Mozilla Thunderbird</span>
<span class="sd">- Apple Mail</span>
<span class="sd">- Microsoft Outlook (PST/OST files)</span>
<span class="sd">- Generic mbox/maildir formats</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mailbox</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">email</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">email.utils</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">email.message</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span>

<span class="c1"># Try to import rich for enhanced UI</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">rich.console</span><span class="w"> </span><span class="kn">import</span> <span class="n">Console</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">rich.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">rich.progress</span><span class="w"> </span><span class="kn">import</span> <span class="n">Progress</span><span class="p">,</span> <span class="n">SpinnerColumn</span><span class="p">,</span> <span class="n">TextColumn</span><span class="p">,</span> <span class="n">BarColumn</span><span class="p">,</span> <span class="n">TimeElapsedColumn</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">rich.prompt</span><span class="w"> </span><span class="kn">import</span> <span class="n">Confirm</span><span class="p">,</span> <span class="n">Prompt</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">rich</span><span class="w"> </span><span class="kn">import</span> <span class="nb">print</span> <span class="k">as</span> <span class="n">rprint</span>
    <span class="n">RICH_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># Define placeholders so our code doesn&#39;t break without rich</span>
    <span class="n">Console</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Table</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Progress</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">SpinnerColumn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">TextColumn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">BarColumn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">TimeElapsedColumn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Confirm</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Prompt</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rprint</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">RICH_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rich library not found. Install with: pip install rich&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Basic terminal output will be used instead.&quot;</span><span class="p">)</span>

<span class="c1"># Constants for email client paths</span>
<span class="n">EMAIL_CLIENT_PATHS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;thunderbird&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/.thunderbird&quot;</span><span class="p">),</span>                       <span class="c1"># Linux</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/Library/Thunderbird&quot;</span><span class="p">),</span>                <span class="c1"># macOS</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/AppData/Roaming/Thunderbird&quot;</span><span class="p">),</span>        <span class="c1"># Windows</span>
    <span class="p">],</span>
    <span class="s1">&#39;apple_mail&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/Library/Mail&quot;</span><span class="p">),</span>                       <span class="c1"># macOS Mail.app</span>
    <span class="p">],</span>
    <span class="s1">&#39;outlook&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/Documents/Outlook Files&quot;</span><span class="p">),</span>            <span class="c1"># Common Outlook storage location</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/AppData/Local/Microsoft/Outlook&quot;</span><span class="p">),</span>    <span class="c1"># Windows Outlook OST/PST location</span>
    <span class="p">],</span>
    <span class="s1">&#39;generic_maildir&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/Maildir&quot;</span><span class="p">),</span>                            <span class="c1"># Standard Maildir location</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/mail&quot;</span><span class="p">),</span>                               <span class="c1"># Common mail location</span>
    <span class="p">],</span>
<span class="p">}</span>

<span class="c1"># Email format types</span>
<span class="n">EMAIL_FORMAT_TYPES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mbox&#39;</span><span class="p">,</span> <span class="s1">&#39;maildir&#39;</span><span class="p">,</span> <span class="s1">&#39;pst&#39;</span><span class="p">,</span> <span class="s1">&#39;ost&#39;</span><span class="p">,</span> <span class="s1">&#39;emlx&#39;</span><span class="p">,</span> <span class="s1">&#39;eml&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="BaseEmailClientHandler">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.BaseEmailClientHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BaseEmailClientHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for email client handlers.&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="n">Console</span><span class="p">()</span> <span class="k">if</span> <span class="n">RICH_AVAILABLE</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mail_folders</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_name</span> <span class="o">=</span> <span class="s2">&quot;Generic&quot;</span>
        
<div class="viewcode-block" id="BaseEmailClientHandler.find_profile_paths">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.BaseEmailClientHandler.find_profile_paths">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_profile_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find profile directories on the system.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Subclasses must implement this method&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="BaseEmailClientHandler.find_mail_folders">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.BaseEmailClientHandler.find_mail_folders">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_mail_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find mail folders in the profiles.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Subclasses must implement this method&quot;</span><span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_scan_for_mail_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Scan directory for mail files (generic implementation).&quot;&quot;&quot;</span>
        <span class="n">mail_files</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Check if directory exists to avoid errors</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">mail_files</span>
            
        <span class="c1"># Generic scan for common mail file formats</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                <span class="n">file_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                
                <span class="c1"># Skip known non-mail files</span>
                <span class="k">if</span> <span class="n">file_ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.html&#39;</span><span class="p">,</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;.js&#39;</span><span class="p">,</span> <span class="s1">&#39;.json&#39;</span><span class="p">,</span> <span class="s1">&#39;.css&#39;</span><span class="p">]:</span>
                    <span class="k">continue</span>
                
                <span class="c1"># Look for common mail formats</span>
                <span class="n">mail_type</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">file_ext</span> <span class="o">==</span> <span class="s1">&#39;.mbox&#39;</span> <span class="ow">or</span> <span class="n">file</span> <span class="o">==</span> <span class="s1">&#39;INBOX&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">file_ext</span><span class="p">:</span>
                    <span class="n">mail_type</span> <span class="o">=</span> <span class="s1">&#39;mbox&#39;</span>
                <span class="k">elif</span> <span class="n">file_ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.eml&#39;</span><span class="p">,</span> <span class="s1">&#39;.emlx&#39;</span><span class="p">]:</span>
                    <span class="n">mail_type</span> <span class="o">=</span> <span class="s1">&#39;eml&#39;</span>
                <span class="k">elif</span> <span class="n">file_ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.pst&#39;</span><span class="p">,</span> <span class="s1">&#39;.ost&#39;</span><span class="p">]:</span>
                    <span class="n">mail_type</span> <span class="o">=</span> <span class="s1">&#39;pst&#39;</span> <span class="k">if</span> <span class="n">file_ext</span> <span class="o">==</span> <span class="s1">&#39;.pst&#39;</span> <span class="k">else</span> <span class="s1">&#39;ost&#39;</span>
                
                <span class="k">if</span> <span class="n">mail_type</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">rel_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>
                    <span class="n">display_path</span> <span class="o">=</span> <span class="n">folder_name</span>
                    <span class="k">if</span> <span class="n">rel_path</span> <span class="ow">and</span> <span class="n">rel_path</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
                        <span class="n">display_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">rel_path</span><span class="si">}</span><span class="s2">&quot;</span>
                        
                    <span class="n">mail_files</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">file_path</span><span class="p">,</span>
                        <span class="s1">&#39;display_name&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">display_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">mail_type</span><span class="p">,</span>
                        <span class="s1">&#39;client&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_name</span>
                    <span class="p">})</span>
                
        <span class="k">return</span> <span class="n">mail_files</span></div>



<div class="viewcode-block" id="ThunderbirdMailHandler">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.ThunderbirdMailHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ThunderbirdMailHandler</span><span class="p">(</span><span class="n">BaseEmailClientHandler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handler for Mozilla Thunderbird email client.&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_name</span> <span class="o">=</span> <span class="s2">&quot;Thunderbird&quot;</span>
    
<div class="viewcode-block" id="ThunderbirdMailHandler.find_profile_paths">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.ThunderbirdMailHandler.find_profile_paths">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_profile_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find Thunderbird profile directories on the system.&quot;&quot;&quot;</span>
        <span class="n">found_profiles</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">base_path</span> <span class="ow">in</span> <span class="n">EMAIL_CLIENT_PATHS</span><span class="p">[</span><span class="s1">&#39;thunderbird&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">base_path</span><span class="p">):</span>
                <span class="k">continue</span>
                
            <span class="c1"># Look for profiles.ini</span>
            <span class="n">profiles_ini</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s2">&quot;profiles.ini&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">profiles_ini</span><span class="p">):</span>
                <span class="c1"># Parse profiles.ini to find profile directories</span>
                <span class="n">profile_dirs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_profiles_ini</span><span class="p">(</span><span class="n">profiles_ini</span><span class="p">,</span> <span class="n">base_path</span><span class="p">)</span>
                <span class="n">found_profiles</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">profile_dirs</span><span class="p">)</span>
            
            <span class="c1"># Direct search for profile directories (fallback)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">found_profiles</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">base_path</span><span class="p">):</span>
                    <span class="n">item_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">item_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.default&quot;</span><span class="p">):</span>
                        <span class="n">found_profiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_path</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_paths</span> <span class="o">=</span> <span class="n">found_profiles</span>
        <span class="k">return</span> <span class="n">found_profiles</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_profiles_ini</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profiles_ini_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse the profiles.ini file to extract profile paths.&quot;&quot;&quot;</span>
        <span class="n">profile_dirs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_section</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">is_profile_section</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">profiles_ini_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    
                    <span class="c1"># New section</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">is_profile_section</span> <span class="ow">and</span> <span class="s1">&#39;Path&#39;</span> <span class="ow">in</span> <span class="n">current_section</span><span class="p">:</span>
                            <span class="n">path</span> <span class="o">=</span> <span class="n">current_section</span><span class="p">[</span><span class="s1">&#39;Path&#39;</span><span class="p">]</span>
                            
                            <span class="c1"># Handle relative vs absolute paths</span>
                            <span class="k">if</span> <span class="n">current_section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;IsRelative&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
                                <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">full_path</span> <span class="o">=</span> <span class="n">path</span>
                                
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">full_path</span><span class="p">):</span>
                                <span class="n">profile_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
                        
                        <span class="n">current_section</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">is_profile_section</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[Profile&#39;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    
                    <span class="c1"># Key-value pair</span>
                    <span class="k">if</span> <span class="s1">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">current_section</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                
                <span class="c1"># Check the last section</span>
                <span class="k">if</span> <span class="n">is_profile_section</span> <span class="ow">and</span> <span class="s1">&#39;Path&#39;</span> <span class="ow">in</span> <span class="n">current_section</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">current_section</span><span class="p">[</span><span class="s1">&#39;Path&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">current_section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;IsRelative&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
                        <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">full_path</span> <span class="o">=</span> <span class="n">path</span>
                        
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">full_path</span><span class="p">):</span>
                        <span class="n">profile_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow]Warning: Error parsing profiles.ini: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">[/yellow]&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Error parsing profiles.ini: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">profile_dirs</span>
    
<div class="viewcode-block" id="ThunderbirdMailHandler.find_mail_folders">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.ThunderbirdMailHandler.find_mail_folders">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_mail_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find mail folders within Thunderbird profiles.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_paths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">find_profile_paths</span><span class="p">()</span>
            
        <span class="n">mail_folders</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">profile_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_paths</span><span class="p">:</span>
            <span class="n">mail_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">profile_path</span><span class="p">,</span> <span class="s2">&quot;Mail&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mail_dir</span><span class="p">):</span>
                <span class="k">continue</span>
                
            <span class="c1"># First look for Mail/Local Folders structure</span>
            <span class="n">local_folders</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mail_dir</span><span class="p">,</span> <span class="s2">&quot;Local Folders&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_folders</span><span class="p">):</span>
                <span class="n">mail_folders</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scan_for_thunderbird_mail_files</span><span class="p">(</span><span class="n">local_folders</span><span class="p">,</span> <span class="s2">&quot;Local Folders&quot;</span><span class="p">))</span>
            
            <span class="c1"># Look for other mail folders in the Mail directory</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">mail_dir</span><span class="p">):</span>
                <span class="n">item_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mail_dir</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">item_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span> <span class="o">!=</span> <span class="s2">&quot;Local Folders&quot;</span><span class="p">:</span>
                    <span class="n">mail_folders</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scan_for_thunderbird_mail_files</span><span class="p">(</span><span class="n">item_path</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
            
            <span class="c1"># For newer Thunderbird versions: ImapMail folder with server subdirectories</span>
            <span class="n">imap_mail</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">profile_path</span><span class="p">,</span> <span class="s2">&quot;ImapMail&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">imap_mail</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">server_dir</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">imap_mail</span><span class="p">):</span>
                    <span class="n">server_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imap_mail</span><span class="p">,</span> <span class="n">server_dir</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">server_path</span><span class="p">):</span>
                        <span class="n">mail_folders</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scan_for_thunderbird_mail_files</span><span class="p">(</span><span class="n">server_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ImapMail/</span><span class="si">{</span><span class="n">server_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">mail_folders</span> <span class="o">=</span> <span class="n">mail_folders</span>
        <span class="k">return</span> <span class="n">mail_folders</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_scan_for_thunderbird_mail_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recursively scan directory for Thunderbird mail files (.msf, .mbox files).&quot;&quot;&quot;</span>
        <span class="n">mail_files</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Check if directory exists to avoid errors</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">mail_files</span>
            
        <span class="c1"># First pass: check for files with .msf counterparts (standard Thunderbird approach)</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                
                <span class="c1"># Thunderbird common mail file patterns</span>
                <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.msf&quot;</span><span class="p">):</span>
                    <span class="c1"># .msf files are indexes, actual mail data is in the file without .msf</span>
                    <span class="n">mail_file</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>  <span class="c1"># Remove .msf extension</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mail_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">mail_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">rel_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>
                        <span class="n">display_path</span> <span class="o">=</span> <span class="n">folder_name</span>
                        <span class="k">if</span> <span class="n">rel_path</span> <span class="ow">and</span> <span class="n">rel_path</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
                            <span class="n">display_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">rel_path</span><span class="si">}</span><span class="s2">&quot;</span>
                            
                        <span class="n">mail_files</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">mail_file</span><span class="p">,</span>
                            <span class="s1">&#39;display_name&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">display_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;mbox&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;client&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_name</span>
                        <span class="p">})</span>
                        
        <span class="c1"># Second pass: if we didn&#39;t find any .msf files, look for raw mail files</span>
        <span class="c1"># This handles demo mode and some non-standard setups</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mail_files</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                    
                    <span class="c1"># Skip known non-mail files</span>
                    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.msf&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.html&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.txt&quot;</span><span class="p">):</span>
                        <span class="k">continue</span>
                        
                    <span class="c1"># If file has no extension and has reasonable size, consider it a potential mbox</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">rel_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>
                        <span class="n">display_path</span> <span class="o">=</span> <span class="n">folder_name</span>
                        <span class="k">if</span> <span class="n">rel_path</span> <span class="ow">and</span> <span class="n">rel_path</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
                            <span class="n">display_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">rel_path</span><span class="si">}</span><span class="s2">&quot;</span>
                            
                        <span class="n">mail_files</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">file_path</span><span class="p">,</span>
                            <span class="s1">&#39;display_name&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">display_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;mbox&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;client&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_name</span>
                        <span class="p">})</span>
                    <span class="k">elif</span> <span class="n">file</span> <span class="o">==</span> <span class="s2">&quot;INBOX&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.msf&quot;</span><span class="p">,</span> <span class="s2">&quot;.html&quot;</span><span class="p">,</span> <span class="s2">&quot;.xhtml&quot;</span><span class="p">,</span> <span class="s2">&quot;.js&quot;</span><span class="p">,</span> <span class="s2">&quot;.json&quot;</span><span class="p">)):</span>
                        <span class="c1"># Potential mailbox file (could be mbox format)</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">rel_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>
                            <span class="n">display_path</span> <span class="o">=</span> <span class="n">folder_name</span>
                            <span class="k">if</span> <span class="n">rel_path</span> <span class="ow">and</span> <span class="n">rel_path</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
                                <span class="n">display_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">rel_path</span><span class="si">}</span><span class="s2">&quot;</span>
                                
                            <span class="n">mail_files</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                                <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">file_path</span><span class="p">,</span>
                                <span class="s1">&#39;display_name&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">display_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;mbox&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;client&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_name</span>
                            <span class="p">})</span>
                        
        <span class="k">return</span> <span class="n">mail_files</span></div>



<div class="viewcode-block" id="AppleMailHandler">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.AppleMailHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AppleMailHandler</span><span class="p">(</span><span class="n">BaseEmailClientHandler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handler for Apple Mail.app email client.&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_name</span> <span class="o">=</span> <span class="s2">&quot;Apple Mail&quot;</span>
    
<div class="viewcode-block" id="AppleMailHandler.find_profile_paths">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.AppleMailHandler.find_profile_paths">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_profile_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find Apple Mail profile directories on the system.&quot;&quot;&quot;</span>
        <span class="n">found_profiles</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">base_path</span> <span class="ow">in</span> <span class="n">EMAIL_CLIENT_PATHS</span><span class="p">[</span><span class="s1">&#39;apple_mail&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">base_path</span><span class="p">):</span>
                <span class="k">continue</span>
                
            <span class="c1"># Apple Mail creates version folders like V2, V6, V8, etc.</span>
            <span class="c1"># We need to look for the highest version</span>
            <span class="n">version_dirs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">base_path</span><span class="p">):</span>
                <span class="n">item_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">item_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">version_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">item_path</span><span class="p">))</span>
            
            <span class="c1"># Sort by version number (descending) and add the paths</span>
            <span class="n">version_dirs</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">version_dirs</span><span class="p">:</span>
                <span class="n">found_profiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_paths</span> <span class="o">=</span> <span class="n">found_profiles</span>
        <span class="k">return</span> <span class="n">found_profiles</span></div>

    
<div class="viewcode-block" id="AppleMailHandler.find_mail_folders">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.AppleMailHandler.find_mail_folders">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_mail_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find mail folders within Apple Mail profiles.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_paths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">find_profile_paths</span><span class="p">()</span>
            
        <span class="n">mail_folders</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">profile_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_paths</span><span class="p">:</span>
            <span class="c1"># Look for standard Apple Mail folder patterns</span>
            <span class="k">for</span> <span class="n">folder_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Mailboxes&quot;</span><span class="p">,</span> <span class="s2">&quot;IMAP&quot;</span><span class="p">,</span> <span class="s2">&quot;POP&quot;</span><span class="p">]:</span>
                <span class="n">folder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">profile_path</span><span class="p">,</span> <span class="n">folder_type</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
                    <span class="n">mail_folders</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scan_for_apple_mail_files</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">folder_type</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">mail_folders</span> <span class="o">=</span> <span class="n">mail_folders</span>
        <span class="k">return</span> <span class="n">mail_folders</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_scan_for_apple_mail_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recursively scan directory for Apple Mail files.&quot;&quot;&quot;</span>
        <span class="n">mail_files</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Check if directory exists to avoid errors</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">mail_files</span>
            
        <span class="c1"># Apple Mail uses .emlx files for individual messages and .mbox directories for mailboxes</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="c1"># Process .emlx files</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.emlx&#39;</span><span class="p">):</span>
                    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                    <span class="n">rel_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>
                    <span class="n">display_path</span> <span class="o">=</span> <span class="n">folder_name</span>
                    <span class="k">if</span> <span class="n">rel_path</span> <span class="ow">and</span> <span class="n">rel_path</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
                        <span class="n">display_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">rel_path</span><span class="si">}</span><span class="s2">&quot;</span>
                        
                    <span class="n">mail_files</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">file_path</span><span class="p">,</span>
                        <span class="s1">&#39;display_name&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">display_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;emlx&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;client&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_name</span>
                    <span class="p">})</span>
            
            <span class="c1"># Look for .mbox directories which contain message collections</span>
            <span class="k">for</span> <span class="n">dir_name</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dir_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.mbox&#39;</span><span class="p">):</span>
                    <span class="n">dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">)</span>
                    <span class="c1"># Check for &#39;mbox&#39; file inside the .mbox directory</span>
                    <span class="n">mbox_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="s1">&#39;mbox&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mbox_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">mbox_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">rel_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>
                        <span class="n">display_path</span> <span class="o">=</span> <span class="n">folder_name</span>
                        <span class="k">if</span> <span class="n">rel_path</span> <span class="ow">and</span> <span class="n">rel_path</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
                            <span class="n">display_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">rel_path</span><span class="si">}</span><span class="s2">&quot;</span>
                            
                        <span class="n">mail_files</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">mbox_file</span><span class="p">,</span>
                            <span class="s1">&#39;display_name&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">display_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">dir_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;mbox&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;client&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_name</span>
                        <span class="p">})</span>
                
        <span class="k">return</span> <span class="n">mail_files</span></div>



<div class="viewcode-block" id="OutlookHandler">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.OutlookHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OutlookHandler</span><span class="p">(</span><span class="n">BaseEmailClientHandler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handler for Microsoft Outlook email client.&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_name</span> <span class="o">=</span> <span class="s2">&quot;Outlook&quot;</span>
    
<div class="viewcode-block" id="OutlookHandler.find_profile_paths">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.OutlookHandler.find_profile_paths">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_profile_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find Outlook profile directories on the system.&quot;&quot;&quot;</span>
        <span class="n">found_profiles</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">base_path</span> <span class="ow">in</span> <span class="n">EMAIL_CLIENT_PATHS</span><span class="p">[</span><span class="s1">&#39;outlook&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">base_path</span><span class="p">):</span>
                <span class="k">continue</span>
                
            <span class="c1"># Scan for .pst and .ost files</span>
            <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">base_path</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pst&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.ost&#39;</span><span class="p">):</span>
                        <span class="n">found_profiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
                        <span class="k">break</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">found_profiles</span><span class="p">))</span>  <span class="c1"># Remove duplicates</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_paths</span></div>

    
<div class="viewcode-block" id="OutlookHandler.find_mail_folders">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.OutlookHandler.find_mail_folders">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_mail_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find Outlook PST/OST files.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_paths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">find_profile_paths</span><span class="p">()</span>
            
        <span class="n">mail_folders</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">profile_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_paths</span><span class="p">:</span>
            <span class="c1"># Scan for PST/OST files</span>
            <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">profile_path</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pst&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.ost&#39;</span><span class="p">):</span>
                        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                        <span class="n">mail_type</span> <span class="o">=</span> <span class="s1">&#39;pst&#39;</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pst&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;ost&#39;</span>
                        <span class="n">folder_name</span> <span class="o">=</span> <span class="s2">&quot;Outlook Files&quot;</span>
                        <span class="n">rel_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">profile_path</span><span class="p">)</span>
                        <span class="n">display_path</span> <span class="o">=</span> <span class="n">folder_name</span>
                        <span class="k">if</span> <span class="n">rel_path</span> <span class="ow">and</span> <span class="n">rel_path</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
                            <span class="n">display_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">rel_path</span><span class="si">}</span><span class="s2">&quot;</span>
                        
                        <span class="n">mail_folders</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">file_path</span><span class="p">,</span>
                            <span class="s1">&#39;display_name&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">display_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">mail_type</span><span class="p">,</span>
                            <span class="s1">&#39;client&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_name</span>
                        <span class="p">})</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">mail_folders</span> <span class="o">=</span> <span class="n">mail_folders</span>
        <span class="k">return</span> <span class="n">mail_folders</span></div>
</div>



<div class="viewcode-block" id="GenericMailHandler">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.GenericMailHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">GenericMailHandler</span><span class="p">(</span><span class="n">BaseEmailClientHandler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handler for generic mailbox formats (mbox, maildir, etc.).&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_name</span> <span class="o">=</span> <span class="s2">&quot;Generic&quot;</span>
    
<div class="viewcode-block" id="GenericMailHandler.find_profile_paths">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.GenericMailHandler.find_profile_paths">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_profile_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find common mail directories on the system.&quot;&quot;&quot;</span>
        <span class="n">found_profiles</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">base_path</span> <span class="ow">in</span> <span class="n">EMAIL_CLIENT_PATHS</span><span class="p">[</span><span class="s1">&#39;generic_maildir&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">base_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">base_path</span><span class="p">):</span>
                <span class="n">found_profiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_path</span><span class="p">)</span>
        
        <span class="c1"># Also scan the home directory for common mail folders</span>
        <span class="n">home_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Mail&#39;</span><span class="p">,</span> <span class="s1">&#39;mail&#39;</span><span class="p">,</span> <span class="s1">&#39;Maildir&#39;</span><span class="p">,</span> <span class="s1">&#39;.mail&#39;</span><span class="p">]:</span>
            <span class="n">mail_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mail_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">mail_path</span><span class="p">):</span>
                <span class="n">found_profiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mail_path</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_paths</span> <span class="o">=</span> <span class="n">found_profiles</span>
        <span class="k">return</span> <span class="n">found_profiles</span></div>

    
<div class="viewcode-block" id="GenericMailHandler.find_mail_folders">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.GenericMailHandler.find_mail_folders">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_mail_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find mail folders in common locations.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_paths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">find_profile_paths</span><span class="p">()</span>
            
        <span class="n">mail_folders</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">profile_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_paths</span><span class="p">:</span>
            <span class="c1"># Use the generic scan method from the base class</span>
            <span class="n">mail_folders</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scan_for_mail_files</span><span class="p">(</span><span class="n">profile_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">profile_path</span><span class="p">)))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">mail_folders</span> <span class="o">=</span> <span class="n">mail_folders</span>
        <span class="k">return</span> <span class="n">mail_folders</span></div>
</div>



<div class="viewcode-block" id="EmailClientManager">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.EmailClientManager">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EmailClientManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manager for multiple email client handlers.&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="n">Console</span><span class="p">()</span> <span class="k">if</span> <span class="n">RICH_AVAILABLE</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;thunderbird&#39;</span><span class="p">:</span> <span class="n">ThunderbirdMailHandler</span><span class="p">(),</span>
            <span class="s1">&#39;apple_mail&#39;</span><span class="p">:</span> <span class="n">AppleMailHandler</span><span class="p">(),</span>
            <span class="s1">&#39;outlook&#39;</span><span class="p">:</span> <span class="n">OutlookHandler</span><span class="p">(),</span>
            <span class="s1">&#39;generic&#39;</span><span class="p">:</span> <span class="n">GenericMailHandler</span><span class="p">()</span>
        <span class="p">}</span>
        
<div class="viewcode-block" id="EmailClientManager.get_all_mail_folders">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.EmailClientManager.get_all_mail_folders">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_mail_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get mail folders from all supported email clients.&quot;&quot;&quot;</span>
        <span class="n">all_folders</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">handler_name</span><span class="p">,</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">client_folders</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">find_mail_folders</span><span class="p">()</span>
                <span class="n">all_folders</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">client_folders</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="ow">and</span> <span class="n">client_folders</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[green]Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">client_folders</span><span class="p">)</span><span class="si">}</span><span class="s2"> folders from </span><span class="si">{</span><span class="n">handler</span><span class="o">.</span><span class="n">client_name</span><span class="si">}</span><span class="s2">[/green]&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">client_folders</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">client_folders</span><span class="p">)</span><span class="si">}</span><span class="s2"> folders from </span><span class="si">{</span><span class="n">handler</span><span class="o">.</span><span class="n">client_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow]Error scanning </span><span class="si">{</span><span class="n">handler_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">[/yellow]&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error scanning </span><span class="si">{</span><span class="n">handler_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">all_folders</span></div>

    
<div class="viewcode-block" id="EmailClientManager.get_client_folders">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.EmailClientManager.get_client_folders">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_client_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get mail folders for a specific email client.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">client_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Unknown email client: </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown email client: </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        
        <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">client_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">handler</span><span class="o">.</span><span class="n">find_mail_folders</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="DuplicateEmailFinder">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.DuplicateEmailFinder">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DuplicateEmailFinder</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Scan mailboxes and identify duplicate emails.&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="n">Console</span><span class="p">()</span> <span class="k">if</span> <span class="n">RICH_AVAILABLE</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_folder</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email_cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Cache to store email content by group and index</span>
        
<div class="viewcode-block" id="DuplicateEmailFinder.compute_email_hash">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.DuplicateEmailFinder.compute_email_hash">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_email_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute a hash for an email message based on the chosen method.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            msg: The email message</span>
<span class="sd">            method: The hash method to use</span>
<span class="sd">                &#39;strict&#39;: Message-ID + Date + From + Subject + Body hash</span>
<span class="sd">                &#39;content&#39;: Body hash only</span>
<span class="sd">                &#39;headers&#39;: Message-ID + Date + From + Subject</span>
<span class="sd">                &#39;subject-sender&#39;: Subject + From</span>
<span class="sd">                </span>
<span class="sd">        Notes:</span>
<span class="sd">            In demo mode, messages with specific Message-IDs are treated as duplicates</span>
<span class="sd">            to demonstrate the functionality of the tool.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get message headers</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Subject&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">from_addr</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;From&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">message_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Message-ID&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="c1"># SPECIAL HANDLING FOR DEMO MODE:</span>
        <span class="c1"># In demo mode, we know that duplicate messages have identical Message-IDs</span>
        <span class="c1"># For the purpose of the demo, we&#39;ll consider messages with the same Message-ID as duplicates</span>
        <span class="k">if</span> <span class="n">message_id</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&lt;team-meeting-duplicate@example.com&gt;&#39;</span><span class="p">,</span> 
                          <span class="s1">&#39;&lt;company-picnic-duplicate@example.com&gt;&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;&lt;weekly-report-duplicate@example.com&gt;&#39;</span><span class="p">):</span>
            <span class="c1"># Just use the Message-ID as the hash for demo messages</span>
            <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">message_id</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        
        <span class="c1"># Normal processing for regular (non-demo) messages</span>
        <span class="n">hasher</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;strict&#39;</span><span class="p">,</span> <span class="s1">&#39;headers&#39;</span><span class="p">,</span> <span class="s1">&#39;subject-sender&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;subject-sender&#39;</span><span class="p">:</span>
                <span class="c1"># Only use subject and sender</span>
                <span class="n">data</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">from_addr</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;headers&#39;</span><span class="p">:</span>
                <span class="c1"># Use all important headers</span>
                <span class="n">data</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message_id</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">from_addr</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># strict</span>
                <span class="c1"># Use headers + body hash</span>
                <span class="n">data</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message_id</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">from_addr</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
                <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                
                <span class="c1"># Add body content</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">is_multipart</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">walk</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span>
                                <span class="n">body</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">body</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># Continue without the body if there&#39;s an error</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow]Warning: Could not process message body: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">[/yellow]&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not process message body: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># content only</span>
            <span class="c1"># Only use message body</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">is_multipart</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">walk</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span>
                        <span class="n">body</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">hasher</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="DuplicateEmailFinder.scan_folder">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.DuplicateEmailFinder.scan_folder">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">scan_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">hash_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;strict&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scan a mail folder for duplicate messages.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            folder_info: Dictionary with folder path and info</span>
<span class="sd">            hash_method: Method to use for determining duplicates</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            List of duplicate groups in this folder</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_folder</span> <span class="o">=</span> <span class="n">folder_info</span>
        <span class="n">message_hash_map</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mbox</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="n">mbox</span><span class="p">(</span><span class="n">folder_info</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>
            <span class="n">total_messages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mbox</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">Progress</span><span class="p">(</span>
                    <span class="n">SpinnerColumn</span><span class="p">(),</span>
                    <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot;[progress.description]</span><span class="si">{task.description}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">BarColumn</span><span class="p">(),</span>
                    <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot;[progress.percentage]</span><span class="si">{task.percentage:&gt;3.0f}</span><span class="s2">%&quot;</span><span class="p">),</span>
                    <span class="n">TimeElapsedColumn</span><span class="p">(),</span>
                    <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">progress</span><span class="p">:</span>
                    <span class="n">task</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scanning </span><span class="si">{</span><span class="n">folder_info</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total_messages</span><span class="p">)</span>
                    
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg_key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mbox</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="n">mbox</span><span class="p">[</span><span class="n">msg_key</span><span class="p">]</span>
                        <span class="n">email_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_email_hash</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">hash_method</span><span class="p">)</span>
                        
                        <span class="n">message_hash_map</span><span class="p">[</span><span class="n">email_hash</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">msg_key</span><span class="p">,</span>
                            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
                            <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Subject&#39;</span><span class="p">,</span> <span class="s1">&#39;(No Subject)&#39;</span><span class="p">),</span>
                            <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;From&#39;</span><span class="p">,</span> <span class="s1">&#39;(No Sender)&#39;</span><span class="p">),</span>
                            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                            <span class="s1">&#39;folder&#39;</span><span class="p">:</span> <span class="n">folder_info</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span>
                        <span class="p">})</span>
                        
                        <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">advance</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Basic console output</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scanning </span><span class="si">{</span><span class="n">folder_info</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">total_messages</span><span class="si">}</span><span class="s2"> messages)&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg_key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mbox</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Processed </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_messages</span><span class="si">}</span><span class="s2"> messages...&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
                        
                    <span class="n">message</span> <span class="o">=</span> <span class="n">mbox</span><span class="p">[</span><span class="n">msg_key</span><span class="p">]</span>
                    <span class="n">email_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_email_hash</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">hash_method</span><span class="p">)</span>
                    
                    <span class="n">message_hash_map</span><span class="p">[</span><span class="n">email_hash</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">msg_key</span><span class="p">,</span>
                        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
                        <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Subject&#39;</span><span class="p">,</span> <span class="s1">&#39;(No Subject)&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;From&#39;</span><span class="p">,</span> <span class="s1">&#39;(No Sender)&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;folder&#39;</span><span class="p">:</span> <span class="n">folder_info</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span>
                    <span class="p">})</span>
                <span class="nb">print</span><span class="p">()</span>  <span class="c1"># New line after progress output</span>
            
            <span class="c1"># Extract only the groups with duplicates</span>
            <span class="n">duplicate_groups</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">email_hash</span><span class="p">,</span> <span class="n">messages</span> <span class="ow">in</span> <span class="n">message_hash_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Sort messages by date, oldest first (if date parsing succeeds)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]:</span>
                                <span class="c1"># Try to parse the date for sorting</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">parsed_date</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">parsedate_to_datetime</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
                                    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;parsed_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parsed_date</span>
                                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                                    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;parsed_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">min</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;parsed_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">min</span>
                                
                        <span class="n">messages</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;parsed_date&#39;</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="c1"># If date sorting fails, don&#39;t worry about it</span>
                        <span class="k">pass</span>
                        
                    <span class="n">duplicate_groups</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;hash&#39;</span><span class="p">:</span> <span class="n">email_hash</span><span class="p">,</span>
                        <span class="s1">&#39;messages&#39;</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
                        <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
                    <span class="p">})</span>
            
            <span class="n">duplicate_groups</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_groups</span> <span class="o">=</span> <span class="n">duplicate_groups</span>
            <span class="k">return</span> <span class="n">duplicate_groups</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold red]Error scanning folder </span><span class="si">{</span><span class="n">folder_info</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">[/bold red]&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error scanning folder </span><span class="si">{</span><span class="n">folder_info</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span></div>

    
<div class="viewcode-block" id="DuplicateEmailFinder.display_duplicate_groups">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.DuplicateEmailFinder.display_duplicate_groups">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">display_duplicate_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display the identified duplicate groups.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_groups</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[yellow]No duplicate emails found in this folder.[/yellow]&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No duplicate emails found in this folder.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">groups_to_display</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_groups</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">groups_to_display</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_groups</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>
        
        <span class="n">total_dupes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_groups</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[green]Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duplicate_groups</span><span class="p">)</span><span class="si">}</span><span class="s2"> duplicate groups &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">total_dupes</span><span class="si">}</span><span class="s2"> duplicate emails)[/green]&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups_to_display</span><span class="p">):</span>
                <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Duplicate Group </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> emails)&quot;</span><span class="p">)</span>
                <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Index&quot;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;cyan&quot;</span><span class="p">)</span>
                <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;magenta&quot;</span><span class="p">)</span>
                <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;From&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">)</span>
                <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Subject&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
                <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Folder&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;messages&#39;</span><span class="p">]):</span>
                    <span class="n">date_str</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
                    <span class="c1"># Try to format date nicely</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">parsed_date</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">parsedate_to_datetime</span><span class="p">(</span><span class="n">date_str</span><span class="p">)</span>
                        <span class="n">date_str</span> <span class="o">=</span> <span class="n">parsed_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                        <span class="k">pass</span>
                    
                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Mark the first (original) message</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> (orig)&quot;</span><span class="p">,</span>
                            <span class="n">date_str</span><span class="p">,</span>
                            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">][:</span><span class="mi">40</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;...&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">40</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">][:</span><span class="mi">60</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;...&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">60</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;folder&#39;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                            <span class="n">date_str</span><span class="p">,</span>
                            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">][:</span><span class="mi">40</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;...&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">40</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">][:</span><span class="mi">60</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;...&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">60</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;folder&#39;</span><span class="p">]</span>
                        <span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">()</span>  <span class="c1"># Add space between tables</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Basic console output</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duplicate_groups</span><span class="p">)</span><span class="si">}</span><span class="s2"> duplicate groups (</span><span class="si">{</span><span class="n">total_dupes</span><span class="si">}</span><span class="s2"> duplicate emails)&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups_to_display</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Duplicate Group </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> emails)&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;messages&#39;</span><span class="p">]):</span>
                    <span class="n">date_str</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
                    <span class="c1"># Try to format date nicely</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">parsed_date</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">parsedate_to_datetime</span><span class="p">(</span><span class="n">date_str</span><span class="p">)</span>
                        <span class="n">date_str</span> <span class="o">=</span> <span class="n">parsed_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                        <span class="k">pass</span>
                    
                    <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;(original)&quot;</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">marker</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Date: </span><span class="si">{</span><span class="n">date_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   From: </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Subject: </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Folder: </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;folder&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="DuplicateEmailFinder.get_email_content">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.DuplicateEmailFinder.get_email_content">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_email_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">msg_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the full content of an email in a duplicate group.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            group_idx: Index of the duplicate group</span>
<span class="sd">            msg_idx: Index of the message within the group</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with email headers and content</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_groups</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No duplicate groups available&quot;</span><span class="p">}</span>
            
        <span class="k">if</span> <span class="n">group_idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">group_idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duplicate_groups</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Invalid group index: </span><span class="si">{</span><span class="n">group_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
            
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_groups</span><span class="p">[</span><span class="n">group_idx</span><span class="p">]</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;messages&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">msg_idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">msg_idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Invalid message index: </span><span class="si">{</span><span class="n">msg_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
            
        <span class="n">msg_info</span> <span class="o">=</span> <span class="n">messages</span><span class="p">[</span><span class="n">msg_idx</span><span class="p">]</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">msg_info</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
        
        <span class="c1"># Get all headers</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">headers</span><span class="p">[</span><span class="n">header</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="n">header</span><span class="p">]</span>
        
        <span class="c1"># Get body content</span>
        <span class="n">body_parts</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">is_multipart</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">walk</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">get_content_maintype</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">charset</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">get_content_charset</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;utf-8&#39;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">decoded_content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">charset</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
                            <span class="n">body_parts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                                <span class="s1">&#39;content_type&#39;</span><span class="p">:</span> <span class="n">part</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">(),</span>
                                <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">decoded_content</span>
                            <span class="p">})</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">body_parts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                                <span class="s1">&#39;content_type&#39;</span><span class="p">:</span> <span class="n">part</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">(),</span>
                                <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error decoding content: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">charset</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get_content_charset</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;utf-8&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">decoded_content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">charset</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
                    <span class="n">body_parts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;content_type&#39;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">(),</span>
                        <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">decoded_content</span>
                    <span class="p">})</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">body_parts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;content_type&#39;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">(),</span>
                        <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error decoding content: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">body_parts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;content_type&#39;</span><span class="p">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">,</span>
                <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error extracting message content: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">})</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;group_index&#39;</span><span class="p">:</span> <span class="n">group_idx</span><span class="p">,</span>
            <span class="s1">&#39;message_index&#39;</span><span class="p">:</span> <span class="n">msg_idx</span><span class="p">,</span>
            <span class="s1">&#39;headers&#39;</span><span class="p">:</span> <span class="n">headers</span><span class="p">,</span>
            <span class="s1">&#39;body_parts&#39;</span><span class="p">:</span> <span class="n">body_parts</span><span class="p">,</span>
            <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="n">msg_info</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">],</span>
            <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">msg_info</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">],</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">msg_info</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span>
            <span class="s1">&#39;folder&#39;</span><span class="p">:</span> <span class="n">msg_info</span><span class="p">[</span><span class="s1">&#39;folder&#39;</span><span class="p">]</span>
        <span class="p">}</span></div>

    
<div class="viewcode-block" id="DuplicateEmailFinder.delete_duplicates">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.DuplicateEmailFinder.delete_duplicates">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_duplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_indices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> 
                          <span class="n">selection_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;keep-first&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete selected duplicate emails.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            group_indices: List of group indices to process</span>
<span class="sd">            selection_method: How to select which duplicates to remove</span>
<span class="sd">                &#39;keep-first&#39;: Keep the first (oldest) email in each group</span>
<span class="sd">                &#39;interactive&#39;: Ask user which emails to keep/delete</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (number of deleted emails, list of errors)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_groups</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;No duplicates to delete&quot;</span><span class="p">]</span>
        
        <span class="n">deleted_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Validate group indices</span>
        <span class="n">valid_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">group_indices</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duplicate_groups</span><span class="p">):</span>
                <span class="n">valid_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid group index: </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_indices</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="n">errors</span>
        
        <span class="c1"># Open the mailbox</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mbox</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="n">mbox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_folder</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>
            
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">valid_indices</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_groups</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">messages</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;messages&#39;</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">selection_method</span> <span class="o">==</span> <span class="s1">&#39;interactive&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[bold]Duplicate Group </span><span class="si">{</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">[/bold]&quot;</span><span class="p">)</span>
                        
                        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Index&quot;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;cyan&quot;</span><span class="p">)</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;magenta&quot;</span><span class="p">)</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;From&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">)</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Subject&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
                        
                        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">messages</span><span class="p">):</span>
                            <span class="n">date_str</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">parsed_date</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">parsedate_to_datetime</span><span class="p">(</span><span class="n">date_str</span><span class="p">)</span>
                                <span class="n">date_str</span> <span class="o">=</span> <span class="n">parsed_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                                <span class="k">pass</span>
                            
                            <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot; (suggested to keep)&quot;</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="si">}{</span><span class="n">marker</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">date_str</span><span class="p">,</span>
                                <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">][:</span><span class="mi">40</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;...&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">40</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                                <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">][:</span><span class="mi">60</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;...&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">60</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                            <span class="p">)</span>
                        
                        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
                        
                        <span class="c1"># Ask which to keep</span>
                        <span class="n">to_keep</span> <span class="o">=</span> <span class="n">Prompt</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span>
                            <span class="s2">&quot;Enter the index of the email to keep (default: 1)&quot;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;1&quot;</span>
                        <span class="p">)</span>
                        
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">keep_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">to_keep</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Convert to 0-based index</span>
                            <span class="k">if</span> <span class="n">keep_idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">keep_idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[red]Invalid index, using default (keeping first email)[/red]&quot;</span><span class="p">)</span>
                                <span class="n">keep_idx</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[red]Invalid input, using default (keeping first email)[/red]&quot;</span><span class="p">)</span>
                            <span class="n">keep_idx</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Basic console output</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Duplicate Group </span><span class="si">{</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
                        
                        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">messages</span><span class="p">):</span>
                            <span class="n">date_str</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">parsed_date</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">parsedate_to_datetime</span><span class="p">(</span><span class="n">date_str</span><span class="p">)</span>
                                <span class="n">date_str</span> <span class="o">=</span> <span class="n">parsed_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                                <span class="k">pass</span>
                            
                            <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot; (suggested to keep)&quot;</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="si">}{</span><span class="n">marker</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Date: </span><span class="si">{</span><span class="n">date_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   From: </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Subject: </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">()</span>
                        
                        <span class="c1"># Ask which to keep</span>
                        <span class="n">to_keep</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter the index of the email to keep (default: 1): &quot;</span><span class="p">)</span>
                        
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">keep_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">to_keep</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Convert to 0-based index</span>
                            <span class="k">if</span> <span class="n">keep_idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">keep_idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">):</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid index, using default (keeping first email)&quot;</span><span class="p">)</span>
                                <span class="n">keep_idx</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid input, using default (keeping first email)&quot;</span><span class="p">)</span>
                            <span class="n">keep_idx</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Keep first email automatically</span>
                    <span class="n">keep_idx</span> <span class="o">=</span> <span class="mi">0</span>
                
                <span class="c1"># Delete all emails except the one to keep</span>
                <span class="n">deletion_keys</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">messages</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">keep_idx</span><span class="p">:</span>
                        <span class="n">deletion_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">])</span>
                
                <span class="c1"># Confirm deletion</span>
                <span class="k">if</span> <span class="n">selection_method</span> <span class="o">==</span> <span class="s1">&#39;interactive&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">:</span>
                        <span class="n">confirm</span> <span class="o">=</span> <span class="n">Confirm</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Delete </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">deletion_keys</span><span class="p">)</span><span class="si">}</span><span class="s2"> duplicates from this group?&quot;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">confirm_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Delete </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">deletion_keys</span><span class="p">)</span><span class="si">}</span><span class="s2"> duplicates from this group? (Y/n): &quot;</span><span class="p">)</span>
                        <span class="n">confirm</span> <span class="o">=</span> <span class="n">confirm_input</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;n&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">confirm</span> <span class="o">=</span> <span class="kc">True</span>
                
                <span class="k">if</span> <span class="n">confirm</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">deletion_keys</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">mbox</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                            <span class="n">deleted_count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error deleting message </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]</span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Flush changes</span>
            <span class="n">mbox</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="n">deleted_count</span><span class="p">,</span> <span class="n">errors</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error opening mailbox </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_folder</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold red]</span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">[/bold red]&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">error_msg</span><span class="p">]</span></div>
</div>



<div class="viewcode-block" id="create_test_mailbox">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.create_test_mailbox">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_test_mailbox</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a test mailbox for demo purposes.&quot;&quot;&quot;</span>
    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;thunderbird_test_&quot;</span><span class="p">)</span>
    <span class="n">profile_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">profile_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Create mail directory structure (following Thunderbird&#39;s structure)</span>
    <span class="c1"># Important: The path must match exactly what our scanner expects</span>
    <span class="n">mail_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">profile_dir</span><span class="p">,</span> <span class="s2">&quot;Mail&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">mail_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Create Local Folders structure</span>
    <span class="n">local_folders_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mail_dir</span><span class="p">,</span> <span class="s2">&quot;Local Folders&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">local_folders_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Create INBOX and its subfolder directory (.sbd)</span>
    <span class="n">inbox_sbd_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_folders_dir</span><span class="p">,</span> <span class="s2">&quot;Inbox.sbd&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">inbox_sbd_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Create INBOX mbox file</span>
    <span class="n">inbox_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_folders_dir</span><span class="p">,</span> <span class="s2">&quot;Inbox&quot;</span><span class="p">)</span>
    <span class="n">test_mbox</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="n">mbox</span><span class="p">(</span><span class="n">inbox_path</span><span class="p">)</span>
    
    <span class="c1"># Add some sample emails with duplicates</span>
    <span class="n">sample_emails</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="s2">&quot;Team Meeting Tomorrow&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;boss@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;you@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;Mon, 01 Apr 2025 10:00:00 -0400&quot;</span><span class="p">,</span>
            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="s2">&quot;Let&#39;s meet tomorrow at 10 AM to discuss the project progress.&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="s2">&quot;Team Meeting Tomorrow&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;boss@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;you@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;Mon, 01 Apr 2025 10:05:00 -0400&quot;</span><span class="p">,</span>
            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="s2">&quot;Let&#39;s meet tomorrow at 10 AM to discuss the project progress.&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="s2">&quot;Invitation: Company Picnic&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;events@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;all-staff@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;Tue, 02 Apr 2025 09:30:00 -0400&quot;</span><span class="p">,</span>
            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="s2">&quot;You&#39;re invited to our annual company picnic this Saturday.&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="s2">&quot;Invitation: Company Picnic&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;events@example.com&quot;</span><span class="p">,</span> 
            <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;all-staff@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;Tue, 02 Apr 2025 09:35:00 -0400&quot;</span><span class="p">,</span>
            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="s2">&quot;You&#39;re invited to our annual company picnic this Saturday.&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="s2">&quot;Invitation: Company Picnic&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;events@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;all-staff@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;Tue, 02 Apr 2025 09:40:00 -0400&quot;</span><span class="p">,</span> 
            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="s2">&quot;You&#39;re invited to our annual company picnic this Saturday.&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="s2">&quot;Weekly Report Due&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;manager@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;you@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;Wed, 03 Apr 2025 16:15:00 -0400&quot;</span><span class="p">,</span>
            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="s2">&quot;Please submit your weekly report by EOD tomorrow.&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
    
    <span class="k">for</span> <span class="n">email_data</span> <span class="ow">in</span> <span class="n">sample_emails</span><span class="p">:</span>
        <span class="c1"># Create a new email message</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">EmailMessage</span><span class="p">()</span>
        <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;Subject&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email_data</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">]</span>
        <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;From&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email_data</span><span class="p">[</span><span class="s2">&quot;from&quot;</span><span class="p">]</span>
        <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;To&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email_data</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">]</span>
        <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email_data</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span>
        
        <span class="c1"># For duplicates, use the same Message-ID</span>
        <span class="c1"># This guarantees they&#39;ll be detected as duplicates with the &#39;strict&#39; criteria</span>
        <span class="k">if</span> <span class="n">email_data</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Team Meeting Tomorrow&quot;</span><span class="p">:</span>
            <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;Message-ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&lt;team-meeting-duplicate@example.com&gt;&quot;</span>
        <span class="k">elif</span> <span class="n">email_data</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Invitation: Company Picnic&quot;</span><span class="p">:</span>
            <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;Message-ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&lt;company-picnic-duplicate@example.com&gt;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;Message-ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="nb">hash</span><span class="p">(</span><span class="n">email_data</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">email_data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">@example.com&gt;&quot;</span>
            
        <span class="n">msg</span><span class="o">.</span><span class="n">set_content</span><span class="p">(</span><span class="n">email_data</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">])</span>
        
        <span class="c1"># Add to mailbox</span>
        <span class="n">test_mbox</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    
    <span class="n">test_mbox</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    
    <span class="c1"># Create MSF index file (just for structure completeness)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">inbox_path</span><span class="si">}</span><span class="s2">.msf&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;dummy msf index file&quot;</span><span class="p">)</span>
    
    <span class="c1"># Create another mailbox (Sent) with a couple of emails</span>
    <span class="n">sent_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_folders_dir</span><span class="p">,</span> <span class="s2">&quot;Sent&quot;</span><span class="p">)</span>
    <span class="n">sent_mbox</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="n">mbox</span><span class="p">(</span><span class="n">sent_path</span><span class="p">)</span>
    
    <span class="n">sent_emails</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="s2">&quot;Re: Weekly Report&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;you@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;manager@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;Wed, 03 Apr 2025 17:30:00 -0400&quot;</span><span class="p">,</span>
            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="s2">&quot;Attached is my weekly report. Let me know if you need any clarification.&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="s2">&quot;Re: Weekly Report&quot;</span><span class="p">,</span>
            <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;you@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;manager@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;Wed, 03 Apr 2025 17:35:00 -0400&quot;</span><span class="p">,</span>
            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="s2">&quot;Attached is my weekly report. Let me know if you need any clarification.&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
    
    <span class="k">for</span> <span class="n">email_data</span> <span class="ow">in</span> <span class="n">sent_emails</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">EmailMessage</span><span class="p">()</span>
        <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;Subject&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email_data</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">]</span>
        <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;From&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email_data</span><span class="p">[</span><span class="s2">&quot;from&quot;</span><span class="p">]</span>
        <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;To&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email_data</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">]</span>
        <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email_data</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span>
        
        <span class="c1"># Make sure our sent emails are detected as duplicates</span>
        <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;Message-ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&lt;weekly-report-duplicate@example.com&gt;&quot;</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">set_content</span><span class="p">(</span><span class="n">email_data</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">])</span>
        <span class="n">sent_mbox</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    
    <span class="n">sent_mbox</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sent_path</span><span class="si">}</span><span class="s2">.msf&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;dummy msf index file&quot;</span><span class="p">)</span>
    
    <span class="c1"># Create a simple profiles.ini file</span>
    <span class="n">profiles_ini_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">profiles_ini_dir</span><span class="p">,</span> <span class="s2">&quot;profiles.ini&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[Profile0]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Name=default</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;IsRelative=1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Path=default</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Default=1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Print the structure for debugging</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created test mailbox structure at: </span><span class="si">{</span><span class="n">temp_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">temp_dir</span><span class="p">,</span> <span class="n">profile_dir</span></div>


<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../modules.html#email_duplicate_cleaner.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main function to run the Email Duplicate Cleaner.&quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Email Duplicate Cleaner 2.2.3- Find and remove duplicate emails from various email clients.&quot;</span><span class="p">,</span>
        <span class="n">epilog</span><span class="o">=</span><span class="s2">&quot;Example: python email_duplicate_cleaner.py --client thunderbird --scan-all --criteria subject-sender&quot;</span>
    <span class="p">)</span>
    
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--scan-path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Manually specify a mail folder path to scan&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--scan-all&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Scan all found email client profiles&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--client&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;thunderbird&quot;</span><span class="p">,</span> <span class="s2">&quot;apple_mail&quot;</span><span class="p">,</span> <span class="s2">&quot;outlook&quot;</span><span class="p">,</span> <span class="s2">&quot;generic&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">],</span>
                        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Email client to scan (default: all)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--criteria&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;strict&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="s2">&quot;subject-sender&quot;</span><span class="p">],</span>
                        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;strict&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Criteria for detecting duplicates (default: strict)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--auto-clean&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Automatically clean duplicates without interactive selection&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--list-folders&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;List mail folders and exit without scanning&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--demo&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> 
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run in demo mode with test emails&quot;</span><span class="p">)</span>
    
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    
    <span class="c1"># Initialize client manager and duplicate finder</span>
    <span class="n">client_manager</span> <span class="o">=</span> <span class="n">EmailClientManager</span><span class="p">()</span>
    <span class="n">duplicate_finder</span> <span class="o">=</span> <span class="n">DuplicateEmailFinder</span><span class="p">()</span>
    
    <span class="c1"># Rich console if available</span>
    <span class="n">console</span> <span class="o">=</span> <span class="n">Console</span><span class="p">()</span> <span class="k">if</span> <span class="n">RICH_AVAILABLE</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="c1"># Set up a demo environment if requested</span>
    <span class="n">temp_dir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">demo</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">console</span><span class="p">:</span>
            <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[bold cyan]Running in demo mode with test emails...[/bold cyan]&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running in demo mode with test emails...&quot;</span><span class="p">)</span>
        
        <span class="n">temp_dir</span><span class="p">,</span> <span class="n">profile_path</span> <span class="o">=</span> <span class="n">create_test_mailbox</span><span class="p">()</span>
        <span class="n">args</span><span class="o">.</span><span class="n">scan_path</span> <span class="o">=</span> <span class="n">profile_path</span>
    
    <span class="k">if</span> <span class="n">console</span><span class="p">:</span>
        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[bold blue]Email Duplicate Cleaner[/bold blue]&quot;</span><span class="p">)</span>
        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;Searching for email client profiles...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Email Duplicate Cleaner&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Searching for email client profiles...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Find mail folders based on client selection</span>
    <span class="n">mail_folders</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">scan_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">scan_path</span><span class="p">):</span>
            <span class="c1"># Create a generic mail handler to scan this path</span>
            <span class="n">custom_handler</span> <span class="o">=</span> <span class="n">GenericMailHandler</span><span class="p">()</span>
            <span class="n">custom_handler</span><span class="o">.</span><span class="n">profile_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">scan_path</span><span class="p">]</span>
            <span class="n">mail_folders</span> <span class="o">=</span> <span class="n">custom_handler</span><span class="o">.</span><span class="n">find_mail_folders</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">console</span><span class="p">:</span>
                <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold red]Error: Specified path not found: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">scan_path</span><span class="si">}</span><span class="s2">[/bold red]&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Specified path not found: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">scan_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Get mail folders based on client selection</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">client</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">mail_folders</span> <span class="o">=</span> <span class="n">client_manager</span><span class="o">.</span><span class="n">get_all_mail_folders</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mail_folders</span> <span class="o">=</span> <span class="n">client_manager</span><span class="o">.</span><span class="n">get_client_folders</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mail_folders</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">console</span><span class="p">:</span>
            <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[bold red]Error: No mail folders found.[/bold red]&quot;</span><span class="p">)</span>
            <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;Please ensure that the selected email client is installed and has been configured,&quot;</span><span class="p">)</span>
            <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;or specify a folder path manually with --scan-path.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: No mail folders found.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please ensure that the selected email client is installed and has been configured,&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;or specify a folder path manually with --scan-path.&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">console</span><span class="p">:</span>
        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[green]Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mail_folders</span><span class="p">)</span><span class="si">}</span><span class="s2"> mail folders:[/green]&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mail_folders</span><span class="p">)</span><span class="si">}</span><span class="s2"> mail folders:&quot;</span><span class="p">)</span>
    
    <span class="c1"># List mail folders</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">folder</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mail_folders</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">console</span><span class="p">:</span>
            <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">folder</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">folder</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">list_folders</span><span class="p">:</span>
        <span class="c1"># Exit if only listing folders</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># Process mail folders</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">scan_all</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">auto_clean</span><span class="p">:</span>
        <span class="c1"># Auto-select all folders for scan-all or auto-clean modes</span>
        <span class="n">folders_to_scan</span> <span class="o">=</span> <span class="n">mail_folders</span>
        <span class="k">if</span> <span class="n">console</span><span class="p">:</span>
            <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[bold]Scanning all folders automatically[/bold]&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Scanning all folders automatically&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Interactive folder selection</span>
        <span class="k">if</span> <span class="n">console</span><span class="p">:</span>
            <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[bold]Select folders to scan for duplicates:[/bold]&quot;</span><span class="p">)</span>
            <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;Enter folder numbers separated by commas, or &#39;all&#39; for all folders&quot;</span><span class="p">)</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="n">Prompt</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;Folders to scan&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Select folders to scan for duplicates:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Enter folder numbers separated by commas, or &#39;all&#39; for all folders&quot;</span><span class="p">)</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Folders to scan [all]: &quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;all&quot;</span>
        
        <span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">folders_to_scan</span> <span class="o">=</span> <span class="n">mail_folders</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
                <span class="n">folders_to_scan</span> <span class="o">=</span> <span class="p">[</span><span class="n">mail_folders</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">mail_folders</span><span class="p">)]</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">folders_to_scan</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">console</span><span class="p">:</span>
                        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[bold red]Error: No valid folders selected.[/bold red]&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: No valid folders selected.&quot;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">console</span><span class="p">:</span>
                    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[bold red]Error: Invalid folder selection.[/bold red]&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Invalid folder selection.&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Display selected duplicate detection criteria</span>
    <span class="n">criteria_desc</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;strict&quot;</span><span class="p">:</span> <span class="s2">&quot;Message-ID + Date + From + Subject + Content&quot;</span><span class="p">,</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Message content only&quot;</span><span class="p">,</span>
        <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="s2">&quot;Message-ID + Date + From + Subject&quot;</span><span class="p">,</span>
        <span class="s2">&quot;subject-sender&quot;</span><span class="p">:</span> <span class="s2">&quot;Subject + From&quot;</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="n">console</span><span class="p">:</span>
        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[bold]Duplicate detection criteria:[/bold] </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">criteria</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">criteria_desc</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">criteria</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Duplicate detection criteria: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">criteria</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">criteria_desc</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">criteria</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Scan each selected folder</span>
    <span class="n">total_dupes</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_groups</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders_to_scan</span><span class="p">:</span>
        <span class="n">duplicate_groups</span> <span class="o">=</span> <span class="n">duplicate_finder</span><span class="o">.</span><span class="n">scan_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">criteria</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">duplicate_groups</span><span class="p">:</span>
            <span class="n">folder_dupes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">duplicate_groups</span><span class="p">)</span>
            <span class="n">total_dupes</span> <span class="o">+=</span> <span class="n">folder_dupes</span>
            <span class="n">total_groups</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicate_groups</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">console</span><span class="p">:</span>
                <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[bold green]Folder: </span><span class="si">{</span><span class="n">folder</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">[/bold green]&quot;</span><span class="p">)</span>
                <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">duplicate_groups</span><span class="p">)</span><span class="si">}</span><span class="s2"> duplicate groups (</span><span class="si">{</span><span class="n">folder_dupes</span><span class="si">}</span><span class="s2"> duplicate emails)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Folder: </span><span class="si">{</span><span class="n">folder</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">duplicate_groups</span><span class="p">)</span><span class="si">}</span><span class="s2"> duplicate groups (</span><span class="si">{</span><span class="n">folder_dupes</span><span class="si">}</span><span class="s2"> duplicate emails)&quot;</span><span class="p">)</span>
            
            <span class="c1"># Display duplicates</span>
            <span class="n">duplicate_finder</span><span class="o">.</span><span class="n">display_duplicate_groups</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">auto_clean</span><span class="p">:</span>
                <span class="c1"># Interactive deletion</span>
                <span class="k">if</span> <span class="n">console</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">Confirm</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;Delete duplicates from this folder?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                        <span class="c1"># Ask which groups to process</span>
                        <span class="n">group_input</span> <span class="o">=</span> <span class="n">Prompt</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span>
                            <span class="s2">&quot;Enter group numbers to process (comma-separated), or &#39;all&#39;&quot;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;all&quot;</span>
                        <span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">group_input</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                            <span class="n">group_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">duplicate_groups</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">group_indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">group_input</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[red]Invalid input, no groups will be processed[/red]&quot;</span><span class="p">)</span>
                                <span class="n">group_indices</span> <span class="o">=</span> <span class="p">[]</span>
                        
                        <span class="k">if</span> <span class="n">group_indices</span><span class="p">:</span>
                            <span class="n">deleted</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">duplicate_finder</span><span class="o">.</span><span class="n">delete_duplicates</span><span class="p">(</span>
                                <span class="n">group_indices</span><span class="p">,</span> <span class="n">selection_method</span><span class="o">=</span><span class="s1">&#39;interactive&#39;</span>
                            <span class="p">)</span>
                            
                            <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[green]Deleted </span><span class="si">{</span><span class="n">deleted</span><span class="si">}</span><span class="s2"> duplicate emails[/green]&quot;</span><span class="p">)</span>
                            
                            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                                <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[yellow]Some errors occurred during deletion:[/yellow]&quot;</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>  <span class="c1"># Show first 5 errors</span>
                                    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                                    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ... and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> more errors&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Delete duplicates from this folder? (y/N): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                        <span class="c1"># Ask which groups to process</span>
                        <span class="n">group_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter group numbers to process (comma-separated), or &#39;all&#39;: &quot;</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">group_input</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                            <span class="n">group_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">duplicate_groups</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">group_indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">group_input</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid input, no groups will be processed&quot;</span><span class="p">)</span>
                                <span class="n">group_indices</span> <span class="o">=</span> <span class="p">[]</span>
                        
                        <span class="k">if</span> <span class="n">group_indices</span><span class="p">:</span>
                            <span class="n">deleted</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">duplicate_finder</span><span class="o">.</span><span class="n">delete_duplicates</span><span class="p">(</span>
                                <span class="n">group_indices</span><span class="p">,</span> <span class="n">selection_method</span><span class="o">=</span><span class="s1">&#39;interactive&#39;</span>
                            <span class="p">)</span>
                            
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted </span><span class="si">{</span><span class="n">deleted</span><span class="si">}</span><span class="s2"> duplicate emails&quot;</span><span class="p">)</span>
                            
                            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Some errors occurred during deletion:&quot;</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>  <span class="c1"># Show first 5 errors</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ... and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> more errors&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Automatic cleaning</span>
                <span class="k">if</span> <span class="n">console</span><span class="p">:</span>
                    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[bold]Auto-cleaning duplicates...[/bold]&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Auto-cleaning duplicates...&quot;</span><span class="p">)</span>
                    
                <span class="n">deleted</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">duplicate_finder</span><span class="o">.</span><span class="n">delete_duplicates</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">duplicate_groups</span><span class="p">))),</span> <span class="n">selection_method</span><span class="o">=</span><span class="s1">&#39;keep-first&#39;</span>
                <span class="p">)</span>
                
                <span class="k">if</span> <span class="n">console</span><span class="p">:</span>
                    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[green]Deleted </span><span class="si">{</span><span class="n">deleted</span><span class="si">}</span><span class="s2"> duplicate emails[/green]&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[yellow]Some errors occurred during deletion:[/yellow]&quot;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>
                            <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                            <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ... and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> more errors&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted </span><span class="si">{</span><span class="n">deleted</span><span class="si">}</span><span class="s2"> duplicate emails&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Some errors occurred during deletion:&quot;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ... and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> more errors&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">console</span><span class="p">:</span>
                <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow]No duplicates found in </span><span class="si">{</span><span class="n">folder</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">[/yellow]&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No duplicates found in </span><span class="si">{</span><span class="n">folder</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Summary</span>
    <span class="k">if</span> <span class="n">console</span><span class="p">:</span>
        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[bold]Scan Summary:[/bold]&quot;</span><span class="p">)</span>
        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scanned </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">folders_to_scan</span><span class="p">)</span><span class="si">}</span><span class="s2"> folders&quot;</span><span class="p">)</span>
        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">total_groups</span><span class="si">}</span><span class="s2"> duplicate groups with </span><span class="si">{</span><span class="n">total_dupes</span><span class="si">}</span><span class="s2"> duplicate emails&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Scan Summary:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scanned </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">folders_to_scan</span><span class="p">)</span><span class="si">}</span><span class="s2"> folders&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">total_groups</span><span class="si">}</span><span class="s2"> duplicate groups with </span><span class="si">{</span><span class="n">total_dupes</span><span class="si">}</span><span class="s2"> duplicate emails&quot;</span><span class="p">)</span>
    
    <span class="c1"># Clean up temp directory if in demo mode</span>
    <span class="k">if</span> <span class="n">temp_dir</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">console</span><span class="p">:</span>
                <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[dim]Cleaned up demo environment[/dim]&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">console</span><span class="p">:</span>
                <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[dim]Note: Could not clean up demo directory: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">[/dim]&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">console</span><span class="p">:</span>
        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[bold blue]Done![/bold blue]&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Done!&quot;</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_email_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">msg_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the full content of an email in a duplicate group.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            group_idx: Index of the duplicate group</span>
<span class="sd">            msg_idx: Index of the message within the group</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with email headers and content</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">group_idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">group_idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duplicate_groups</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Invalid group index: </span><span class="si">{</span><span class="n">group_idx</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
            
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_groups</span><span class="p">[</span><span class="n">group_idx</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">msg_idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">msg_idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;messages&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Invalid message index: </span><span class="si">{</span><span class="n">msg_idx</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
            
        <span class="n">msg_info</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;messages&#39;</span><span class="p">][</span><span class="n">msg_idx</span><span class="p">]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Open the email file</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_demo_mode</span><span class="p">:</span>
                <span class="c1"># In demo mode, construct a simpler representation</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;From&#39;</span><span class="p">:</span> <span class="n">msg_info</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;To&#39;</span><span class="p">:</span> <span class="s1">&#39;recipient@example.com&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="n">msg_info</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Subject&#39;</span><span class="p">:</span> <span class="n">msg_info</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Message-ID&#39;</span><span class="p">:</span> <span class="n">msg_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;demo_id&gt;&#39;</span><span class="p">),</span>
                <span class="p">}</span>
                
                <span class="c1"># Get pre-defined body based on the subject</span>
                <span class="k">if</span> <span class="s1">&#39;Monthly Report&#39;</span> <span class="ow">in</span> <span class="n">msg_info</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]:</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="s1">&#39;This is the monthly report for March 2025.</span><span class="se">\n\n</span><span class="s1">Sales have increased by 15</span><span class="si">% c</span><span class="s1">ompared to last month.</span><span class="se">\n\n</span><span class="s1">Please review the attached spreadsheet for details.&#39;</span>
                <span class="k">elif</span> <span class="s1">&#39;Meeting&#39;</span> <span class="ow">in</span> <span class="n">msg_info</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]:</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="s1">&#39;Let</span><span class="se">\&#39;</span><span class="s1">s meet to discuss the project status.</span><span class="se">\n\n</span><span class="s1">Proposed agenda:</span><span class="se">\n</span><span class="s1">1. Project timeline</span><span class="se">\n</span><span class="s1">2. Budget allocation</span><span class="se">\n</span><span class="s1">3. Resource planning&#39;</span>
                <span class="k">elif</span> <span class="s1">&#39;Reminder&#39;</span> <span class="ow">in</span> <span class="n">msg_info</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]:</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="s1">&#39;Just a reminder about the upcoming deadline on Friday.</span><span class="se">\n\n</span><span class="s1">Please submit your reports by end of day.&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;This is a demo email with subject: </span><span class="si">{</span><span class="n">msg_info</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">The content is generated for demonstration purposes.&#39;</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For real emails, read from the file</span>
                <span class="n">filepath</span> <span class="o">=</span> <span class="n">msg_info</span><span class="p">[</span><span class="s1">&#39;filepath&#39;</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Email file not found: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
                
                <span class="c1"># Parse the email file</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message_from_binary_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                
                <span class="c1"># Extract headers</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;From&#39;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;From&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;To&#39;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;To&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;Cc&#39;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Cc&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;Subject&#39;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Subject&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;Message-ID&#39;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Message-ID&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="p">}</span>
                
                <span class="c1"># Extract body</span>
                <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">is_multipart</span><span class="p">():</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_payload</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">:</span>
                            <span class="n">body</span> <span class="o">+=</span> <span class="n">part</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;headers&#39;</span><span class="p">:</span> <span class="n">headers</span><span class="p">,</span>
                <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="n">body</span><span class="p">,</span>
                <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="n">msg_info</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span>
            <span class="p">}</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Error retrieving email content: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Nsfr750.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>