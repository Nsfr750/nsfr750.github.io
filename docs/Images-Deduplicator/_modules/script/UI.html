

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>script.UI &mdash; Images Deduplicator 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Images Deduplicator
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Images Deduplicator</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">script.UI</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for script.UI</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">UI module for Image Deduplicator application.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt6.QtCore</span><span class="w"> </span><span class="kn">import</span> <span class="n">Qt</span><span class="p">,</span> <span class="n">QTimer</span><span class="p">,</span> <span class="n">QThreadPool</span><span class="p">,</span> <span class="n">QSettings</span><span class="p">,</span> <span class="n">QUrl</span><span class="p">,</span> <span class="n">QThread</span><span class="p">,</span> <span class="n">QMetaObject</span><span class="p">,</span> <span class="n">Q_ARG</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt6.QtWidgets</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">QApplication</span><span class="p">,</span> <span class="n">QMainWindow</span><span class="p">,</span> <span class="n">QWidget</span><span class="p">,</span> <span class="n">QVBoxLayout</span><span class="p">,</span> <span class="n">QHBoxLayout</span><span class="p">,</span> <span class="n">QLabel</span><span class="p">,</span> <span class="n">QPushButton</span><span class="p">,</span> 
    <span class="n">QLineEdit</span><span class="p">,</span> <span class="n">QFileDialog</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="p">,</span> <span class="n">QListWidget</span><span class="p">,</span> <span class="n">QListWidgetItem</span><span class="p">,</span>
    <span class="n">QProgressBar</span><span class="p">,</span> <span class="n">QFrame</span><span class="p">,</span> <span class="n">QSplitter</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="p">,</span> <span class="n">QGroupBox</span><span class="p">,</span> <span class="n">QStatusBar</span><span class="p">,</span>
    <span class="n">QProgressDialog</span><span class="p">,</span> <span class="n">QCheckBox</span><span class="p">,</span> <span class="n">QSlider</span><span class="p">,</span> <span class="n">QDialog</span><span class="p">,</span> <span class="n">QDialogButtonBox</span><span class="p">,</span> <span class="n">QTextEdit</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt6.QtGui</span><span class="w"> </span><span class="kn">import</span> <span class="n">QPixmap</span><span class="p">,</span> <span class="n">QDesktopServices</span><span class="p">,</span> <span class="n">QPainter</span><span class="p">,</span> <span class="n">QColor</span><span class="p">,</span> <span class="n">QImage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wand.image</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span> <span class="k">as</span> <span class="n">WandImage</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">script.translations</span><span class="w"> </span><span class="kn">import</span> <span class="n">t</span><span class="p">,</span> <span class="n">LANGUAGES</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">script.styles</span><span class="w"> </span><span class="kn">import</span> <span class="n">apply_style</span><span class="p">,</span> <span class="n">apply_theme</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">script.about</span><span class="w"> </span><span class="kn">import</span> <span class="n">AboutDialog</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">script.help</span><span class="w"> </span><span class="kn">import</span> <span class="n">HelpDialog</span> <span class="k">as</span> <span class="n">HelpDialogScript</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">script.log_viewer</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogViewer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">script.sponsor</span><span class="w"> </span><span class="kn">import</span> <span class="n">SponsorDialog</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">script.menu</span><span class="w"> </span><span class="kn">import</span> <span class="n">MenuManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">script.updates</span><span class="w"> </span><span class="kn">import</span> <span class="n">UpdateChecker</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">script.version</span><span class="w"> </span><span class="kn">import</span> <span class="n">__version__</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">script.workers</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageComparisonWorker</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">script.settings_dialog</span><span class="w"> </span><span class="kn">import</span> <span class="n">SettingsDialog</span>  
<span class="kn">from</span><span class="w"> </span><span class="nn">script.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">script.undo_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">UndoManager</span><span class="p">,</span> <span class="n">FileOperation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">script.language_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">LanguageManager</span>  

<div class="viewcode-block" id="UI">
<a class="viewcode-back" href="../../api.html#script.UI.UI">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">UI</span><span class="p">(</span><span class="n">QMainWindow</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main UI class for Image Deduplicator.&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="s1">&#39;en&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        
        <span class="c1"># Initialize language manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span> <span class="o">=</span> <span class="n">LanguageManager</span><span class="p">(</span><span class="n">default_lang</span><span class="o">=</span><span class="n">lang</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">current_language</span>  
        
        <span class="bp">self</span><span class="o">.</span><span class="n">duplicates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comparison_in_progress</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Set up logging with DEBUG level</span>
        <span class="n">log_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;logs&quot;</span><span class="p">)</span>
        <span class="n">log_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Configure root logger with DEBUG level</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">handlers</span><span class="o">=</span><span class="p">[</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_dir</span> <span class="o">/</span> <span class="s2">&quot;image_dedup_debug.log&quot;</span><span class="p">),</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
            <span class="p">]</span>
        <span class="p">)</span>
        
        <span class="c1"># Get logger for this module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        
        <span class="c1"># Initialize thread pool for background tasks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_pool</span> <span class="o">=</span> <span class="n">QThreadPool</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Thread pool initialized with max thread count: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_pool</span><span class="o">.</span><span class="n">maxThreadCount</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">update_checker</span> <span class="o">=</span> <span class="n">UpdateChecker</span><span class="p">(</span><span class="n">__version__</span><span class="p">,</span> <span class="n">language_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">log_dir</span> <span class="o">/</span> <span class="s2">&quot;image_dedup.log&quot;</span><span class="p">)</span>
        
        <span class="c1"># Set default style and theme from config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;appearance&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;Fusion&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_theme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;appearance&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;theme&#39;</span><span class="p">,</span> <span class="s1">&#39;dark&#39;</span><span class="p">)</span>
        
        <span class="c1"># Log initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting Image Deduplicator v</span><span class="si">{</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Log file: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Configuration: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Load settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">QSettings</span><span class="p">(</span><span class="s2">&quot;ImageDeduplicator&quot;</span><span class="p">,</span> <span class="s2">&quot;ImageDeduplicator&quot;</span><span class="p">)</span>
        
        <span class="c1"># Initialize undo manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undo_manager</span> <span class="o">=</span> <span class="n">UndoManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undo_action</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Will be set by MenuManager</span>
        
        <span class="c1"># Connect language changed signal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">language_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_language_changed</span><span class="p">)</span>
        
        <span class="c1"># Initialize UI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_ui</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_connections</span><span class="p">()</span>
        
        <span class="c1"># Apply the style and theme</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_style</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_style</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_theme_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Check for updates on startup</span>
        <span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_updates_on_startup</span><span class="p">)</span>

<div class="viewcode-block" id="UI.init_ui">
<a class="viewcode-back" href="../../api.html#script.UI.UI.init_ui">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the user interface.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;app_title&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">__version__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">800</span><span class="p">)</span>
        
        <span class="c1"># Create central widget and main layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">central_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setCentralWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">central_widget</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">central_widget</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        
        <span class="c1"># Initialize menu bar with language manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_manager</span> <span class="o">=</span> <span class="n">MenuManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setMenuBar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">menu_manager</span><span class="o">.</span><span class="n">menubar</span><span class="p">)</span>
        
        <span class="c1"># --- Folder Selection ---</span>
        <span class="n">folder_frame</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
        <span class="n">folder_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">folder_frame</span><span class="p">)</span>
        <span class="n">folder_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">folder_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;select_folder&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder_entry</span> <span class="o">=</span> <span class="n">QLineEdit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder_entry</span><span class="o">.</span><span class="n">setReadOnly</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browse_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;browse&#39;</span><span class="p">))</span>
        
        <span class="n">folder_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder_label</span><span class="p">)</span>
        <span class="n">folder_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder_entry</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">folder_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">browse_button</span><span class="p">)</span>
        
        <span class="c1"># --- Scan Options ---</span>
        <span class="n">options_frame</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
        <span class="n">options_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">options_frame</span><span class="p">)</span>
        <span class="n">options_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        
        <span class="c1"># Recursive search option</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recursive_checkbox</span> <span class="o">=</span> <span class="n">QCheckBox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;search_subfolders&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recursive_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Default to True</span>
        <span class="n">options_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recursive_checkbox</span><span class="p">)</span>
        
        <span class="c1"># Keep better quality option</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_better_quality_checkbox</span> <span class="o">=</span> <span class="n">QCheckBox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;keep_better_quality&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_better_quality_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Default to True</span>
        <span class="n">options_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keep_better_quality_checkbox</span><span class="p">)</span>
        
        <span class="c1"># Preserve metadata option</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preserve_metadata_checkbox</span> <span class="o">=</span> <span class="n">QCheckBox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;preserve_metadata&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preserve_metadata_checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Default to True</span>
        <span class="n">options_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preserve_metadata_checkbox</span><span class="p">)</span>
        
        <span class="n">options_layout</span><span class="o">.</span><span class="n">addStretch</span><span class="p">()</span>
        
        <span class="c1"># --- Similarity Threshold ---</span>
        <span class="n">threshold_frame</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
        <span class="n">threshold_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">threshold_frame</span><span class="p">)</span>
        <span class="n">threshold_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">similarity_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;similarity_threshold&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarity_slider</span> <span class="o">=</span> <span class="n">QSlider</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Orientation</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarity_slider</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># 70% to 100% similarity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarity_slider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">85</span><span class="p">)</span>  <span class="c1"># Default value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarity_value</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;85%&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarity_slider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_value</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">))</span>
        
        <span class="n">threshold_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">similarity_label</span><span class="p">)</span>
        <span class="n">threshold_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">similarity_slider</span><span class="p">)</span>
        <span class="n">threshold_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">similarity_value</span><span class="p">)</span>
        
        <span class="c1"># --- Compare Button ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compare_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;compare&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compare_button</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s2">&quot;compareButton&quot;</span><span class="p">)</span>
        
        <span class="c1"># --- Progress Bar ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_frame</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
        <span class="n">progress_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progress_frame</span><span class="p">)</span>
        <span class="n">progress_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="o">=</span> <span class="n">QProgressBar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">setTextVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_label</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignmentFlag</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
        
        <span class="n">progress_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">)</span>
        <span class="n">progress_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progress_label</span><span class="p">)</span>
        
        <span class="c1"># --- Duplicates List ---</span>
        <span class="n">duplicates_group</span> <span class="o">=</span> <span class="n">QGroupBox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;duplicates_found&#39;</span><span class="p">))</span>
        <span class="n">duplicates_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">duplicates_group</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span> <span class="o">=</span> <span class="n">QListWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="o">.</span><span class="n">setSelectionMode</span><span class="p">(</span><span class="n">QListWidget</span><span class="o">.</span><span class="n">SelectionMode</span><span class="o">.</span><span class="n">ExtendedSelection</span><span class="p">)</span>
        
        <span class="n">duplicates_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="p">)</span>
        
        <span class="c1"># --- Action Buttons ---</span>
        <span class="n">buttons_frame</span> <span class="o">=</span> <span class="n">QFrame</span><span class="p">()</span>
        <span class="n">buttons_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">buttons_frame</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">select_all_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;select_all&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_none_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;select_none&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_selected_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;delete_selected&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_all_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;delete_all_duplicates&#39;</span><span class="p">))</span>
        
        <span class="c1"># Style delete buttons differently</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_selected_button</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s2">&quot;deleteButton&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_all_button</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s2">&quot;deleteButton&quot;</span><span class="p">)</span>
        
        <span class="n">buttons_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_all_button</span><span class="p">)</span>
        <span class="n">buttons_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_none_button</span><span class="p">)</span>
        <span class="n">buttons_layout</span><span class="o">.</span><span class="n">addStretch</span><span class="p">()</span>
        <span class="n">buttons_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delete_selected_button</span><span class="p">)</span>
        <span class="n">buttons_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delete_all_button</span><span class="p">)</span>
        
        <span class="c1"># --- Status Bar ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span> <span class="o">=</span> <span class="n">QStatusBar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setStatusBar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">))</span>
        
        <span class="c1"># Add all widgets to main layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">folder_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">options_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">threshold_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compare_button</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progress_frame</span><span class="p">)</span>  <span class="c1"># Add progress frame to main layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">duplicates_group</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Give more space to duplicates list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">buttons_frame</span><span class="p">)</span>
        
        <span class="c1"># Set minimum sizes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="o">.</span><span class="n">setMinimumHeight</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>  <span class="c1"># Make the list taller to compensate for removed previews</span>
        
        <span class="c1"># Initially hide progress bar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_frame</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="UI.setup_connections">
<a class="viewcode-back" href="../../api.html#script.UI.UI.setup_connections">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up signal-slot connections.&quot;&quot;&quot;</span>
        <span class="c1"># Menu connections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_manager</span><span class="o">.</span><span class="n">action_exit</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        
        <span class="c1"># Button connections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browse_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">browse_folder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compare_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compare_images</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_all_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_all_duplicates</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_none_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_none_duplicates</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_selected_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delete_selected</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_all_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delete_all_duplicates</span><span class="p">)</span>
        
        <span class="c1"># List selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="o">.</span><span class="n">itemSelectionChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_preview</span><span class="p">)</span>
        
        <span class="c1"># Update button states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="o">.</span><span class="n">itemSelectionChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_button_states</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">rowsInserted</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_button_states</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">rowsRemoved</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_button_states</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="UI.apply_style">
<a class="viewcode-back" href="../../api.html#script.UI.UI.apply_style">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_style</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">style_name</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">apply_theme_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the specified style to the application.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            style_name: Name of the style to apply (only &#39;Fusion&#39; is supported)</span>
<span class="sd">            save: Whether to save the style to config</span>
<span class="sd">            apply_theme_flag: Whether to also apply the current theme</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">style_name</span> <span class="o">!=</span> <span class="s1">&#39;Fusion&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Style &#39;</span><span class="si">{</span><span class="n">style_name</span><span class="si">}</span><span class="s2">&#39; is not supported. Using &#39;Fusion&#39; style.&quot;</span><span class="p">)</span>
            <span class="n">style_name</span> <span class="o">=</span> <span class="s1">&#39;Fusion&#39;</span>
        
        <span class="c1"># Apply the style</span>
        <span class="n">apply_style</span><span class="p">(</span><span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">(),</span> <span class="n">style_name</span><span class="p">)</span>
        
        <span class="c1"># Save to config if requested</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;appearance&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;appearance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;appearance&#39;</span><span class="p">][</span><span class="s1">&#39;style&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">style_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_config</span><span class="p">()</span>
        
        <span class="c1"># Apply theme if requested</span>
        <span class="k">if</span> <span class="n">apply_theme_flag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_theme</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_theme</span><span class="p">,</span> <span class="n">apply_style_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="UI.apply_theme">
<a class="viewcode-back" href="../../api.html#script.UI.UI.apply_theme">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_theme</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theme_name</span><span class="p">,</span> <span class="n">apply_style_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the specified theme to the application.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            theme_name: Name of the theme to apply (only &#39;dark&#39; is supported)</span>
<span class="sd">            apply_style_flag: Whether to also apply the current style</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">theme_name</span> <span class="o">!=</span> <span class="s1">&#39;dark&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Theme &#39;</span><span class="si">{</span><span class="n">theme_name</span><span class="si">}</span><span class="s2">&#39; is not supported. Using &#39;dark&#39; theme.&quot;</span><span class="p">)</span>
            <span class="n">theme_name</span> <span class="o">=</span> <span class="s1">&#39;dark&#39;</span>
        
        <span class="c1"># Apply the theme</span>
        <span class="n">apply_theme</span><span class="p">(</span><span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">(),</span> <span class="n">theme_name</span><span class="p">)</span>
        
        <span class="c1"># Save to config</span>
        <span class="k">if</span> <span class="s1">&#39;appearance&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;appearance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;appearance&#39;</span><span class="p">][</span><span class="s1">&#39;theme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">theme_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_config</span><span class="p">()</span>
        
        <span class="c1"># Apply style if requested</span>
        <span class="k">if</span> <span class="n">apply_style_flag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_style</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_style</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_theme_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_save_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the current configuration to the config file.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">config_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">)</span>
            <span class="n">config_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_dir</span> <span class="o">/</span> <span class="s1">&#39;config.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving config: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
<div class="viewcode-block" id="UI.browse_folder">
<a class="viewcode-back" href="../../api.html#script.UI.UI.browse_folder">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">browse_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open a folder selection dialog and update the folder path.&quot;&quot;&quot;</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getExistingDirectory</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;select_folder&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">folder_entry</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">())</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">folder</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">folder_entry</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="UI.compare_images">
<a class="viewcode-back" href="../../api.html#script.UI.UI.compare_images">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compare_images</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start the image comparison process.&quot;&quot;&quot;</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder_entry</span><span class="o">.</span><span class="n">text</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">),</span> 
                              <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;invalid_folder&#39;</span><span class="p">))</span>
            <span class="k">return</span>
            
        <span class="c1"># Get scan options from UI</span>
        <span class="n">recursive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recursive_checkbox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="n">similarity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_slider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="n">keep_better_quality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_better_quality_checkbox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>
        <span class="n">preserve_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preserve_metadata_checkbox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span>

        <span class="c1"># Clear previous results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duplicates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_previews</span><span class="p">()</span>
        
        <span class="c1"># Disable UI during processing and show progress bar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_ui_enabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;preparing_scan&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_frame</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
        <span class="c1"># Create and configure worker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">ImageComparisonWorker</span><span class="p">(</span>
            <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span>
            <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span>
            <span class="n">similarity_threshold</span><span class="o">=</span><span class="n">similarity</span><span class="p">,</span>
            <span class="n">keep_better_quality</span><span class="o">=</span><span class="n">keep_better_quality</span><span class="p">,</span>
            <span class="n">preserve_metadata</span><span class="o">=</span><span class="n">preserve_metadata</span>
        <span class="p">)</span>
        
        <span class="c1"># Connect signals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_progress</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_comparison_finished</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_worker_error</span><span class="p">)</span>
        
        <span class="c1"># Start the worker in the thread pool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_pool</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="p">)</span>
        
        <span class="c1"># Update status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;scanning&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang</span><span class="p">))</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_update_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the progress bar with the given value.&quot;&quot;&quot;</span>
        <span class="c1"># Ensure we&#39;re in the main thread for UI updates</span>
        <span class="k">if</span> <span class="n">QThread</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="p">():</span>
            <span class="n">QMetaObject</span><span class="o">.</span><span class="n">invokeMethod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_update_progress&quot;</span><span class="p">,</span> 
                                   <span class="n">Qt</span><span class="o">.</span><span class="n">ConnectionType</span><span class="o">.</span><span class="n">QueuedConnection</span><span class="p">,</span>
                                   <span class="n">Q_ARG</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="k">return</span>
            
        <span class="c1"># Update progress bar with smooth animation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        
        <span class="c1"># Update status message based on progress</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">95</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;scanning_images_progress&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">progress</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;processing_duplicates&#39;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;scan_complete&#39;</span><span class="p">)</span>
            <span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_worker_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle errors from the worker thread.&quot;&quot;&quot;</span>
        <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">),</span> <span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_ui_enabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comparison_in_progress</span> <span class="o">=</span> <span class="kc">False</span>
    
<div class="viewcode-block" id="UI.on_comparison_finished">
<a class="viewcode-back" href="../../api.html#script.UI.UI.on_comparison_finished">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_comparison_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">duplicates</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle the completion of the image comparison.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Image comparison finished&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comparison_in_progress</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="c1"># Update progress bar and status</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;comparison_complete&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            
            <span class="c1"># Hide progress bar after a short delay</span>
            <span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_frame</span><span class="o">.</span><span class="n">hide</span><span class="p">)</span>
            
            <span class="c1"># Update duplicates list if provided</span>
            <span class="k">if</span> <span class="n">duplicates</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dups</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">dups</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">duplicates</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="si">}</span><span class="s2"> duplicates to display&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">duplicates</span> <span class="o">=</span> <span class="n">duplicates</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_duplicates_list</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No duplicates found&quot;</span><span class="p">)</span>
                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;no_duplicates&#39;</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;no_duplicates_found_message&#39;</span><span class="p">)</span>
                <span class="p">)</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error processing comparison results: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing comparison results: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">),</span>
                <span class="n">error_msg</span>
            <span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Always re-enable UI and clean up</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_ui_enabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>  <span class="c1"># Ensure UI updates are processed</span></div>

    
<div class="viewcode-block" id="UI.update_duplicates_list">
<a class="viewcode-back" href="../../api.html#script.UI.UI.update_duplicates_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_duplicates_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the duplicates list with the current duplicates.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># The duplicates dictionary is now {original_path: [duplicate1_path, duplicate2_path, ...]}</span>
            <span class="k">for</span> <span class="n">original_path</span><span class="p">,</span> <span class="n">dup_paths</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">dup_path</span> <span class="ow">in</span> <span class="n">dup_paths</span><span class="p">:</span>
                    <span class="c1"># Create a display name that shows the relative path from the search directory</span>
                    <span class="n">display_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">dup_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder_entry</span><span class="o">.</span><span class="n">text</span><span class="p">())</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder_entry</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="k">else</span> <span class="n">dup_path</span>
                    
                    <span class="n">item</span> <span class="o">=</span> <span class="n">QListWidgetItem</span><span class="p">(</span><span class="n">display_name</span><span class="p">)</span>
                    <span class="c1"># Store both original and duplicate paths in the item&#39;s data</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">UserRole</span><span class="p">,</span> <span class="p">(</span><span class="n">original_path</span><span class="p">,</span> <span class="n">dup_path</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            
            <span class="c1"># Update status with total number of duplicates found (not the number of groups)</span>
            <span class="n">total_duplicates</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dups</span><span class="p">)</span> <span class="k">for</span> <span class="n">dups</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicates</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;duplicates_found&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="n">total_duplicates</span><span class="p">))</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating duplicates list: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;error_updating_list&#39;</span><span class="p">))</span></div>

    
<div class="viewcode-block" id="UI.update_preview">
<a class="viewcode-back" href="../../api.html#script.UI.UI.update_preview">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_preview</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle selection changes in the duplicates list.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">selected_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="o">.</span><span class="n">selectedItems</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">selected_items</span><span class="p">:</span>
                <span class="k">return</span>
                
            <span class="n">item</span> <span class="o">=</span> <span class="n">selected_items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">item_data</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">UserRole</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">item_data</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_data</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">item_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span>
                
            <span class="n">original_path</span><span class="p">,</span> <span class="n">duplicate_path</span> <span class="o">=</span> <span class="n">item_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">item_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">original_path</span><span class="p">,</span> <span class="n">duplicate_path</span><span class="p">]):</span>
                <span class="k">return</span>
                
            <span class="c1"># Create preview dialog if it doesn&#39;t exist</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;preview_dialog&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">preview_dialog</span> <span class="o">=</span> <span class="n">QDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">preview_dialog</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;image_preview&#39;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">preview_dialog</span><span class="o">.</span><span class="n">setModal</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                
                <span class="n">layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
                
                <span class="c1"># Original image preview</span>
                <span class="n">original_group</span> <span class="o">=</span> <span class="n">QGroupBox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;original_image&#39;</span><span class="p">))</span>
                <span class="n">original_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">original_preview</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">original_preview</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignmentFlag</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">original_preview</span><span class="o">.</span><span class="n">setMinimumSize</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">original_preview</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;background-color: #2d2d2d; border: 1px solid #3a3a3a;&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">original_path_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">original_path_label</span><span class="o">.</span><span class="n">setWordWrap</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">original_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_preview</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">original_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_path_label</span><span class="p">)</span>
                <span class="n">original_group</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">original_layout</span><span class="p">)</span>
                
                <span class="c1"># Duplicate image preview</span>
                <span class="n">duplicate_group</span> <span class="o">=</span> <span class="n">QGroupBox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;duplicate_image&#39;</span><span class="p">))</span>
                <span class="n">duplicate_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_preview</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_preview</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignmentFlag</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_preview</span><span class="o">.</span><span class="n">setMinimumSize</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_preview</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;background-color: #2d2d2d; border: 1px solid #3a3a3a;&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_path_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_path_label</span><span class="o">.</span><span class="n">setWordWrap</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">duplicate_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duplicate_preview</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">duplicate_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duplicate_path_label</span><span class="p">)</span>
                <span class="n">duplicate_group</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">duplicate_layout</span><span class="p">)</span>
                
                <span class="c1"># Add to main layout</span>
                <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">original_group</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">duplicate_group</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="c1"># Close button</span>
                <span class="n">button_box</span> <span class="o">=</span> <span class="n">QDialogButtonBox</span><span class="p">(</span><span class="n">QDialogButtonBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
                <span class="n">button_box</span><span class="o">.</span><span class="n">rejected</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preview_dialog</span><span class="o">.</span><span class="n">reject</span><span class="p">)</span>
                <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">button_box</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">preview_dialog</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">preview_dialog</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">900</span><span class="p">,</span> <span class="mi">800</span><span class="p">)</span>
            
            <span class="c1"># Show the dialog</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preview_dialog</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preview_dialog</span><span class="o">.</span><span class="n">raise_</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preview_dialog</span><span class="o">.</span><span class="n">activateWindow</span><span class="p">()</span>
            
            <span class="c1"># Load and display the images</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_image_preview</span><span class="p">(</span><span class="n">original_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_preview</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_path_label</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_image_preview</span><span class="p">(</span><span class="n">duplicate_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_preview</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_path_label</span><span class="p">)</span>
            
            <span class="c1"># Update status bar with basic info</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;selected_duplicates&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">original</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">original_path</span><span class="p">),</span>
                    <span class="n">duplicate</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">duplicate_path</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in update_preview: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;error_loading_preview&#39;</span><span class="p">))</span></div>

    
<div class="viewcode-block" id="UI.clear_previews">
<a class="viewcode-back" href="../../api.html#script.UI.UI.clear_previews">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_previews</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear all preview widgets.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;preview_dialog&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">preview_dialog</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">preview_dialog</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">preview_dialog</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error clearing previews: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="UI.select_all_duplicates">
<a class="viewcode-back" href="../../api.html#script.UI.UI.select_all_duplicates">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">select_all_duplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select all items in the duplicates list.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="o">.</span><span class="n">selectAll</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="UI.select_none_duplicates">
<a class="viewcode-back" href="../../api.html#script.UI.UI.select_none_duplicates">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">select_none_duplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deselect all items in the duplicates list.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="o">.</span><span class="n">clearSelection</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="UI.delete_selected">
<a class="viewcode-back" href="../../api.html#script.UI.UI.delete_selected">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_selected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete the selected duplicate files with undo support using send2trash.&quot;&quot;&quot;</span>
        <span class="n">selected_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="o">.</span><span class="n">selectedItems</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">selected_items</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;no_items_selected&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Get the full paths of selected items - handle both tuples and strings</span>
        <span class="n">selected_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">selected_items</span><span class="p">:</span>
            <span class="n">path_data</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemDataRole</span><span class="o">.</span><span class="n">UserRole</span><span class="p">)</span>
            <span class="c1"># If it&#39;s a tuple (original, duplicate), take the duplicate path</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_data</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">selected_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Take the duplicate path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selected_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path_data</span><span class="p">))</span>
        
        <span class="c1"># Ask for confirmation</span>
        <span class="n">confirm</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">question</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;confirm_delete&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;confirm_delete_selected&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)),</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">No</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">confirm</span> <span class="o">!=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Process deletions with undo support</span>
        <span class="n">failed_deletions</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Move to trash using send2trash</span>
                <span class="n">trash_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">undo_manager</span><span class="o">.</span><span class="n">move_to_trash</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                
                <span class="c1"># Create an operation for undo</span>
                <span class="n">operation</span> <span class="o">=</span> <span class="n">FileOperation</span><span class="p">(</span>
                    <span class="n">operation_type</span><span class="o">=</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span>
                    <span class="n">source</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>  <span class="c1"># Store original path for undo</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;original_path&#39;</span><span class="p">:</span> <span class="n">file_path</span><span class="p">}</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">undo_manager</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span>
                
                <span class="c1"># Update UI</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="o">.</span><span class="n">takeItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="n">selected_items</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to move </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2"> to trash: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">failed_deletions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        
        <span class="c1"># Show result message</span>
        <span class="k">if</span> <span class="n">failed_deletions</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;failed_to_delete_files&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">failed_deletions</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">selected_paths</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;moved_to_trash&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">))</span>
            <span class="p">)</span>
            
        <span class="c1"># Update UI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_button_states</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_preview</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="UI.delete_all_duplicates">
<a class="viewcode-back" href="../../api.html#script.UI.UI.delete_all_duplicates">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_all_duplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete all duplicate files, keeping only the originals using send2trash.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicates</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;no_duplicates_found&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Count total duplicates to delete</span>
        <span class="n">total_duplicates</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dupes</span><span class="p">)</span> <span class="k">for</span> <span class="n">dupes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicates</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">total_duplicates</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;no_duplicates_to_delete&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Ask for confirmation</span>
        <span class="n">confirm</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">question</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;confirm_delete_all&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;confirm_delete_all_duplicates&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">total_duplicates</span><span class="p">),</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">No</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">confirm</span> <span class="o">!=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Yes</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Process deletions with undo support</span>
        <span class="n">failed_deletions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">deleted_count</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Disable UI during operation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_ui_enabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="c1"># Create progress dialog</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="n">QProgressDialog</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;deleting_duplicates&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">total_duplicates</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;cancel&#39;</span><span class="p">),</span>
                <span class="mi">0</span><span class="p">,</span> <span class="n">total_duplicates</span><span class="p">,</span> <span class="bp">self</span>
            <span class="p">)</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">setWindowModality</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">WindowModality</span><span class="o">.</span><span class="n">WindowModal</span><span class="p">)</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;deleting&#39;</span><span class="p">))</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            
            <span class="c1"># Process each original and its duplicates</span>
            <span class="k">for</span> <span class="n">original</span><span class="p">,</span> <span class="n">duplicates</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">duplicate</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">progress</span><span class="o">.</span><span class="n">wasCanceled</span><span class="p">():</span>
                        <span class="k">break</span>
                        
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Move to trash using send2trash</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">undo_manager</span><span class="o">.</span><span class="n">move_to_trash</span><span class="p">(</span><span class="n">duplicate</span><span class="p">)</span>
                        
                        <span class="c1"># Create an operation for undo</span>
                        <span class="n">operation</span> <span class="o">=</span> <span class="n">FileOperation</span><span class="p">(</span>
                            <span class="n">operation_type</span><span class="o">=</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span>
                            <span class="n">source</span><span class="o">=</span><span class="n">duplicate</span><span class="p">,</span>  <span class="c1"># Store original path for undo</span>
                            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;original_path&#39;</span><span class="p">:</span> <span class="n">duplicate</span><span class="p">}</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">undo_manager</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span>
                        
                        <span class="n">deleted_count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">progress</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">deleted_count</span><span class="p">)</span>
                        <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
                        
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to move </span><span class="si">{</span><span class="n">duplicate</span><span class="si">}</span><span class="s2"> to trash: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">failed_deletions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duplicate</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">progress</span><span class="o">.</span><span class="n">wasCanceled</span><span class="p">():</span>
                    <span class="k">break</span>
                    
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during bulk delete: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;error_during_bulk_delete&#39;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">return</span>
            
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_ui_enabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Show result message</span>
        <span class="k">if</span> <span class="n">failed_deletions</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;warning&#39;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;some_deletions_failed&#39;</span><span class="p">,</span> 
                  <span class="n">success</span><span class="o">=</span><span class="n">deleted_count</span><span class="p">,</span> 
                  <span class="n">failed</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">failed_deletions</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">deleted_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;moved_to_trash&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">deleted_count</span><span class="p">)</span>
            <span class="p">)</span>
            
        <span class="c1"># Update UI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duplicates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        
        <span class="c1"># Clear the preview dialog if it exists</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;preview_dialog&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">preview_dialog</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preview_dialog</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preview_dialog</span> <span class="o">=</span> <span class="kc">None</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">update_button_states</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="UI.update_button_states">
<a class="viewcode-back" href="../../api.html#script.UI.UI.update_button_states">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_button_states</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the state of the action buttons based on the current selection.&quot;&quot;&quot;</span>
        <span class="n">has_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">has_selection</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="o">.</span><span class="n">selectedItems</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">select_all_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">has_items</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_none_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">has_items</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_selected_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">has_selection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_all_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">has_items</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="UI.set_ui_enabled">
<a class="viewcode-back" href="../../api.html#script.UI.UI.set_ui_enabled">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_ui_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enabled</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enable or disable UI elements during long operations.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browse_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compare_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_all_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_none_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_selected_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="o">.</span><span class="n">selectedItems</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_all_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_list</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="UI.show_about">
<a class="viewcode-back" href="../../api.html#script.UI.UI.show_about">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">show_about</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show the about dialog.&quot;&quot;&quot;</span>
        <span class="n">dialog</span> <span class="o">=</span> <span class="n">AboutDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  
        <span class="n">dialog</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="UI.show_help">
<a class="viewcode-back" href="../../api.html#script.UI.UI.show_help">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">show_help</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show the help dialog.&quot;&quot;&quot;</span>
        <span class="n">dialog</span> <span class="o">=</span> <span class="n">HelpDialogScript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="p">)</span>
        <span class="n">dialog</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="UI.show_log_viewer">
<a class="viewcode-back" href="../../api.html#script.UI.UI.show_log_viewer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">show_log_viewer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show the log viewer dialog.&quot;&quot;&quot;</span>
        <span class="n">dialog</span> <span class="o">=</span> <span class="n">LogViewer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  
        <span class="n">dialog</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="UI.show_settings">
<a class="viewcode-back" href="../../api.html#script.UI.UI.show_settings">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">show_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show the settings dialog.&quot;&quot;&quot;</span>
        <span class="n">dialog</span> <span class="o">=</span> <span class="n">SettingsDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dialog</span><span class="o">.</span><span class="n">exec</span><span class="p">():</span>
            <span class="c1"># Apply any changed settings</span>
            <span class="k">if</span> <span class="s1">&#39;appearance&#39;</span> <span class="ow">in</span> <span class="n">dialog</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="n">new_style</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;appearance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;Fusion&#39;</span><span class="p">)</span>
                <span class="n">new_theme</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;appearance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;theme&#39;</span><span class="p">,</span> <span class="s1">&#39;dark&#39;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">new_style</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_style</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_style</span> <span class="o">=</span> <span class="n">new_style</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">apply_style</span><span class="p">(</span><span class="n">new_style</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_theme_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">new_theme</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_theme</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_theme</span> <span class="o">=</span> <span class="n">new_theme</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">apply_theme</span><span class="p">(</span><span class="n">new_theme</span><span class="p">,</span> <span class="n">apply_style_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="UI.show_sponsor">
<a class="viewcode-back" href="../../api.html#script.UI.UI.show_sponsor">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">show_sponsor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show the sponsor dialog.&quot;&quot;&quot;</span>
        <span class="n">dialog</span> <span class="o">=</span> <span class="n">SponsorDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="p">)</span>
        <span class="n">dialog</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="UI.set_language">
<a class="viewcode-back" href="../../api.html#script.UI.UI.set_language">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_language</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lang_code</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the application language.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            lang_code: Language code to set (e.g., &#39;en&#39;, &#39;it&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">set_language</span><span class="p">(</span><span class="n">lang_code</span><span class="p">):</span>
            <span class="c1"># Language was changed, no need to retranslate here as the signal will handle it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Language changed to: </span><span class="si">{</span><span class="n">lang_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

            
<div class="viewcode-block" id="UI.on_language_changed">
<a class="viewcode-back" href="../../api.html#script.UI.UI.on_language_changed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_language_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lang_code</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle language change signal from LanguageManager.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lang</span> <span class="o">=</span> <span class="n">lang_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retranslate_ui</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lang_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_config</span><span class="p">()</span></div>


<div class="viewcode-block" id="UI.retranslate_ui">
<a class="viewcode-back" href="../../api.html#script.UI.UI.retranslate_ui">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">retranslate_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retranslate all UI elements to the current language.&quot;&quot;&quot;</span>
        <span class="c1"># Update window title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;app_title&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">__version__</span><span class="p">))</span>
        
        <span class="c1"># Update main UI elements</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;folder_label&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">folder_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;select_folder&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;browse_button&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">browse_button</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;browse&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;compare_button&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compare_button</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;compare&#39;</span><span class="p">))</span>
        
        <span class="c1"># Update group boxes if they exist</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;duplicates_group&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_group</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;duplicates_found&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;original_group&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">original_group</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;original_image&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;duplicate_group&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_group</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;duplicate_image&#39;</span><span class="p">))</span>
        
        <span class="c1"># Update buttons</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;select_all_button&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">select_all_button</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;select_all&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;select_none_button&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">select_none_button</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;select_none&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;delete_selected_button&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_selected_button</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;delete_selected&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;delete_all_button&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_all_button</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;delete_all_duplicates&#39;</span><span class="p">))</span>
        
        <span class="c1"># Update status bar</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;status_bar&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_in_progress</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">))</span>
        
        <span class="c1"># Update menu items</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;menu_manager&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">menu_manager</span><span class="o">.</span><span class="n">retranslate_ui</span><span class="p">()</span></div>


<div class="viewcode-block" id="UI.check_for_updates_on_startup">
<a class="viewcode-back" href="../../api.html#script.UI.UI.check_for_updates_on_startup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_for_updates_on_startup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check for updates on application startup.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Only check once per day</span>
            <span class="n">last_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s1">&#39;last_update_check&#39;</span><span class="p">)</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
            <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">last_check</span> <span class="o">!=</span> <span class="n">today</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking for updates...&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Use a singleShot timer to ensure the UI is fully initialized</span>
                    <span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_update_check</span><span class="p">)</span>
                    <span class="k">return</span>  <span class="c1"># Exit after scheduling the update check</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error scheduling update check: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># If we get here, either we already checked today or there was an error</span>
            <span class="c1"># Set the last check date to today to avoid checking again</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s1">&#39;last_update_check&#39;</span><span class="p">,</span> <span class="n">today</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in check_for_updates_on_startup: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Set a default last check date to prevent repeated errors</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s1">&#39;last_update_check&#39;</span><span class="p">,</span> <span class="n">today</span> <span class="k">if</span> <span class="s1">&#39;today&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;1970-01-01&#39;</span><span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_perform_update_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform the actual update check.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create a new UpdateChecker instance with language manager</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_checker</span> <span class="o">=</span> <span class="n">UpdateChecker</span><span class="p">(</span>
                <span class="n">__version__</span><span class="p">,</span>
                <span class="n">language_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span>
            <span class="p">)</span>
            
            <span class="c1"># Connect signals</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_checker</span><span class="o">.</span><span class="n">update_available</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_update_available</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_checker</span><span class="o">.</span><span class="n">no_updates</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_no_updates</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_checker</span><span class="o">.</span><span class="n">error_occurred</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_update_error</span><span class="p">)</span>
            
            <span class="c1"># Connect cleanup signals</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_checker</span><span class="o">.</span><span class="n">update_available</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_update_thread</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_checker</span><span class="o">.</span><span class="n">no_updates</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_update_thread</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_checker</span><span class="o">.</span><span class="n">error_occurred</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_update_thread</span><span class="p">)</span>
            
            <span class="c1"># Perform the check in a separate thread</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_thread</span> <span class="o">=</span> <span class="n">QThread</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_checker</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_thread</span><span class="p">)</span>
            
            <span class="c1"># Connect thread signals</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_thread</span><span class="o">.</span><span class="n">started</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_checker</span><span class="o">.</span><span class="n">check_for_updates</span><span class="p">)</span>
            
            <span class="c1"># Start the thread</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in _perform_update_check: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
    <span class="k">def</span><span class="w"> </span><span class="nf">_cleanup_update_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up the update thread and checker.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;update_thread&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_thread</span><span class="o">.</span><span class="n">isRunning</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_thread</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_thread</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_thread</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;update_checker&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_checker</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error cleaning up update thread: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_update_available</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version_info</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle the case when an update is available.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Update available: </span><span class="si">{</span><span class="n">version_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Update last check time</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
            <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s1">&#39;last_update_check&#39;</span><span class="p">,</span> <span class="n">today</span><span class="p">)</span>
            
            <span class="c1"># Show the update dialog</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_show_update_dialog</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;update_available&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">current</span><span class="o">=</span><span class="n">__version__</span><span class="p">,</span>
                    <span class="n">latest</span><span class="o">=</span><span class="n">version_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">version_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="n">version_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;notes&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;no_release_notes&#39;</span><span class="p">))</span>
            <span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error handling update available: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_no_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle the case when no updates are available.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No updates available&quot;</span><span class="p">)</span>
            
            <span class="c1"># Update last check time</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
            <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s1">&#39;last_update_check&#39;</span><span class="p">,</span> <span class="n">today</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error handling no updates: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_update_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle errors during update check.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Update check error: </span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Optionally show a message to the user</span>
            <span class="c1"># self.status_bar.showMessage(f&quot;Update check failed: {error_message}&quot;)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error handling update error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="UI.check_for_updates">
<a class="viewcode-back" href="../../api.html#script.UI.UI.check_for_updates">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_for_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check for application updates.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            silent: If True, don&#39;t show a message when no updates are available</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Prevent multiple simultaneous update checks</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_update_check_in_progress&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_check_in_progress</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Update check already in progress, skipping...&quot;</span><span class="p">)</span>
            <span class="k">return</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_check_in_progress</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Only check once per day if not forced</span>
            <span class="n">last_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s1">&#39;last_update_check&#39;</span><span class="p">)</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
            <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">last_check</span> <span class="o">!=</span> <span class="n">today</span> <span class="ow">or</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># Temporarily force update check for testing</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking for updates...&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Use a singleShot timer to ensure the UI is responsive</span>
                    <span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_update_check</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error scheduling update check: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_check_in_progress</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                    <span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;no_updates_title&#39;</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;already_checked_today&#39;</span><span class="p">),</span>
                        <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Ok</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_check_in_progress</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in check_for_updates: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_check_in_progress</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">),</span>
                    <span class="sa">f</span><span class="s2">&quot;An error occurred while checking for updates: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Ok</span>
                <span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_show_update_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">new_version</span><span class="p">,</span> <span class="n">release_notes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show the update dialog with detailed information.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            message: The update message to display</span>
<span class="sd">            new_version: The new version available</span>
<span class="sd">            release_notes: The release notes for the new version</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create the dialog</span>
            <span class="n">dialog</span> <span class="o">=</span> <span class="n">QDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">dialog</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;update_available_title&#39;</span><span class="p">))</span>
            <span class="n">dialog</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">600</span><span class="p">)</span>
            
            <span class="c1"># Main layout</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">dialog</span><span class="p">)</span>
            
            <span class="c1"># Title</span>
            <span class="n">title_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;update_available_title&#39;</span><span class="p">))</span>
            <span class="n">title_font</span> <span class="o">=</span> <span class="n">title_label</span><span class="o">.</span><span class="n">font</span><span class="p">()</span>
            <span class="n">title_font</span><span class="o">.</span><span class="n">setPointSize</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">title_font</span><span class="o">.</span><span class="n">setBold</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">title_label</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">title_font</span><span class="p">)</span>
            
            <span class="c1"># Version info</span>
            <span class="n">current_version</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;b&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;current_version&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">:&lt;/b&gt; </span><span class="si">{</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">new_version_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;b&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;new_version&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">:&lt;/b&gt; </span><span class="si">{</span><span class="n">new_version</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="n">version_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
            <span class="n">version_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QLabel</span><span class="p">(</span><span class="n">current_version</span><span class="p">))</span>
            <span class="n">version_layout</span><span class="o">.</span><span class="n">addStretch</span><span class="p">()</span>
            <span class="n">version_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QLabel</span><span class="p">(</span><span class="n">new_version_text</span><span class="p">))</span>
            
            <span class="c1"># Release notes</span>
            <span class="n">notes_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;release_notes&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="n">notes_text</span> <span class="o">=</span> <span class="n">QTextEdit</span><span class="p">()</span>
            <span class="n">notes_text</span><span class="o">.</span><span class="n">setReadOnly</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">notes_text</span><span class="o">.</span><span class="n">setHtml</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;pre&gt;</span><span class="si">{</span><span class="n">release_notes</span><span class="si">}</span><span class="s2">&lt;/pre&gt;&quot;</span><span class="p">)</span>
            <span class="n">notes_text</span><span class="o">.</span><span class="n">setMinimumHeight</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
            
            <span class="c1"># Buttons</span>
            <span class="n">button_box</span> <span class="o">=</span> <span class="n">QDialogButtonBox</span><span class="p">()</span>
            <span class="n">download_btn</span> <span class="o">=</span> <span class="n">button_box</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;download_update&#39;</span><span class="p">),</span> 
                <span class="n">QDialogButtonBox</span><span class="o">.</span><span class="n">ButtonRole</span><span class="o">.</span><span class="n">AcceptRole</span>
            <span class="p">)</span>
            <span class="n">later_btn</span> <span class="o">=</span> <span class="n">button_box</span><span class="o">.</span><span class="n">addButton</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;remind_me_later&#39;</span><span class="p">),</span>
                <span class="n">QDialogButtonBox</span><span class="o">.</span><span class="n">ButtonRole</span><span class="o">.</span><span class="n">RejectRole</span>
            <span class="p">)</span>
            
            <span class="c1"># Connect buttons</span>
            <span class="n">download_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_update</span><span class="p">(</span><span class="n">new_version</span><span class="p">))</span>
            <span class="n">later_btn</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dialog</span><span class="o">.</span><span class="n">reject</span><span class="p">)</span>
            
            <span class="c1"># Add widgets to layout</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">title_label</span><span class="p">)</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">version_layout</span><span class="p">)</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">addSpacing</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">notes_label</span><span class="p">)</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">notes_text</span><span class="p">)</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">button_box</span><span class="p">)</span>
            
            <span class="c1"># Show the dialog</span>
            <span class="n">dialog</span><span class="o">.</span><span class="n">setModal</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">dialog</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error showing update dialog: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Fallback to simple message box</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;update_available_title&#39;</span><span class="p">),</span>
                <span class="n">message</span><span class="p">,</span>
                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">StandardButton</span><span class="o">.</span><span class="n">Ok</span>
            <span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_download_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle the download update action.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Open the releases page in the default web browser</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">webbrowser</span>
            <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;https://github.com/Nsfr750/Images-Deduplicator/releases/tag/v</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Update last check time</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
            <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s1">&#39;last_update_check&#39;</span><span class="p">,</span> <span class="n">today</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error opening download page: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">),</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to open download page: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    
<div class="viewcode-block" id="UI.undo_last_operation">
<a class="viewcode-back" href="../../api.html#script.UI.UI.undo_last_operation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">undo_last_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Undo the last file operation.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">undo_manager</span><span class="o">.</span><span class="n">can_undo</span><span class="p">():</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;edit_menu.nothing_to_undo&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">undo_manager</span><span class="o">.</span><span class="n">undo_last_operation</span><span class="p">():</span>
                <span class="c1"># Show success message</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;edit_menu.undo_success&#39;</span><span class="p">))</span>
                
                <span class="c1"># Update undo action state</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">undo_action</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">undo_action</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">undo_manager</span><span class="o">.</span><span class="n">can_undo</span><span class="p">())</span>
                    
                <span class="c1"># Refresh the duplicates list</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compare_images</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;edit_menu.undo_failed&#39;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="s2">&quot;Unknown error&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during undo: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;edit_menu.undo_failed&#39;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="p">)</span></div>

    
<div class="viewcode-block" id="UI.closeEvent">
<a class="viewcode-back" href="../../api.html#script.UI.UI.closeEvent">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">closeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle the close event to ensure proper cleanup of resources.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            event: The close event</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Stop any running worker threads</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;worker&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="p">,</span> <span class="s1">&#39;stop&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">stop</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="p">,</span> <span class="s1">&#39;wait&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">wait</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>  <span class="c1"># Wait up to 1 second</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="p">,</span> <span class="s1">&#39;deleteLater&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;wrapped C/C++ object&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error stopping worker: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="c1"># Clean up update thread if it exists</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;update_thread&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Check if the thread is still valid before accessing it</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_thread</span><span class="p">,</span> <span class="s1">&#39;isRunning&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_thread</span><span class="o">.</span><span class="n">isRunning</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_thread</span><span class="o">.</span><span class="n">isRunning</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">update_thread</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">update_thread</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>  <span class="c1"># Wait up to 1 second</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_thread</span><span class="p">,</span> <span class="s1">&#39;deleteLater&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">update_thread</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;wrapped C/C++ object&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error cleaning up update thread: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_thread</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="c1"># Clean up update checker if it exists</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;update_checker&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_checker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_checker</span><span class="p">,</span> <span class="s1">&#39;deleteLater&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">update_checker</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;wrapped C/C++ object&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error cleaning up update checker: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_checker</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="c1"># Clean up thread pool</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;thread_pool&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">thread_pool</span><span class="o">.</span><span class="n">waitForDone</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>  <span class="c1"># Wait up to 1 second for threads to finish</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">thread_pool</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;wrapped C/C++ object&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error cleaning up thread pool: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
            <span class="c1"># Clean up preview dialog if it exists</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;preview_dialog&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">preview_dialog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preview_dialog</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">preview_dialog</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preview_dialog</span><span class="p">,</span> <span class="s1">&#39;deleteLater&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">preview_dialog</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;wrapped C/C++ object&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error cleaning up preview dialog: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">preview_dialog</span> <span class="o">=</span> <span class="kc">None</span>
                    
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Only log if it&#39;s not a wrapped C++ object error</span>
            <span class="k">if</span> <span class="s1">&#39;wrapped C/C++ object&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during cleanup: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Save window state and geometry</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;windowState&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveState</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveGeometry</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;wrapped C/C++ object&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving window state: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Save config</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_config</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;wrapped C/C++ object&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving config: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Log application exit</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Image Deduplicator shutting down&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        
        <span class="c1"># Accept the close event</span>
        <span class="n">event</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span></div>


<div class="viewcode-block" id="UI.save_duplicates_report">
<a class="viewcode-back" href="../../api.html#script.UI.UI.save_duplicates_report">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_duplicates_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save a report of all duplicates to a file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicates</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;no_duplicates_found_message&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span>
            
        <span class="c1"># Get save file path</span>
        <span class="n">file_path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getSaveFileName</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;save_report&#39;</span><span class="p">),</span>
            <span class="s1">&#39;duplicates_report.txt&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Text Files (*.txt);;All Files (*)&#39;</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_path</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># User cancelled</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="c1"># Write header</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=== Image Deduplicator Report ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated on: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total duplicate groups: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duplicates</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total duplicate files: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dupes</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">dupes</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">duplicates</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># Write each group of duplicates</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">duplicates</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duplicates</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Group </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> ---</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original: </span><span class="si">{</span><span class="n">original</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Duplicates:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># Sort duplicates by path for consistent ordering</span>
                    <span class="k">for</span> <span class="n">dup</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">duplicates</span><span class="p">):</span>
                        <span class="c1"># Get file size in KB</span>
                        <span class="n">size_kb</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">dup</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span>
                        <span class="c1"># Get modification time</span>
                        <span class="n">mtime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">dup</span><span class="p">))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">dup</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">size_kb</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> KB, modified: </span><span class="si">{</span><span class="n">mtime</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    
            <span class="c1"># Show success message</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;report_saved&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">file_path</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved duplicates report to </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;error_saving_report&#39;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving report: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lang_manager</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">),</span>
                <span class="n">error_msg</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="UI.load_image_preview">
<a class="viewcode-back" href="../../api.html#script.UI.UI.load_image_preview">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_image_preview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_path</span><span class="p">,</span> <span class="n">preview_widget</span><span class="p">,</span> <span class="n">path_label</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load and display an image preview in the specified widget with enhanced error handling.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            image_path: Path to the image file</span>
<span class="sd">            preview_widget: QLabel widget to display the image</span>
<span class="sd">            path_label: QLabel widget to display the path</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading image preview for: </span><span class="si">{</span><span class="n">image_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Validate input parameters</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">image_path</span><span class="p">,</span> <span class="n">preview_widget</span><span class="p">,</span> <span class="n">path_label</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing required parameters for image preview&quot;</span><span class="p">)</span>
                
            <span class="c1"># Convert to Path object if it&#39;s a string</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">image_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
            
            <span class="c1"># Check if file exists and is accessible</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">image_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image file not found: </span><span class="si">{</span><span class="n">image_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">PermissionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No read permission for file: </span><span class="si">{</span><span class="n">image_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="c1"># Log basic file info</span>
            <span class="n">file_size</span> <span class="o">=</span> <span class="n">image_path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>  <span class="c1"># Size in MB</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Previewing image: </span><span class="si">{</span><span class="n">image_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">file_size</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB)&quot;</span><span class="p">)</span>
            
            <span class="c1"># Load the image with Wand</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">WandImage</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">image_path</span><span class="p">))</span> <span class="k">as</span> <span class="n">img</span><span class="p">:</span>
                    <span class="c1"># Convert to RGB if necessary (for PNG with alpha channel)</span>
                    <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">alpha_channel</span><span class="p">:</span>
                        <span class="n">img</span><span class="o">.</span><span class="n">background_color</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span>
                        <span class="n">img</span><span class="o">.</span><span class="n">alpha_channel</span> <span class="o">=</span> <span class="s1">&#39;remove&#39;</span>
                    
                    <span class="c1"># Resize for preview while maintaining aspect ratio</span>
                    <span class="n">img</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">resize</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">preview_widget</span><span class="o">.</span><span class="n">width</span><span class="p">()</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">preview_widget</span><span class="o">.</span><span class="n">height</span><span class="p">()</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># Convert to RGB and get raw image data</span>
                    <span class="n">img</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;rgb&#39;</span>
                    <span class="n">img</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">8</span>
                    
                    <span class="c1"># Create QImage from raw RGB data</span>
                    <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span>
                    <span class="n">qimg</span> <span class="o">=</span> <span class="n">QImage</span><span class="p">(</span>
                        <span class="n">img</span><span class="o">.</span><span class="n">make_blob</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">),</span>
                        <span class="n">width</span><span class="p">,</span>
                        <span class="n">height</span><span class="p">,</span>
                        <span class="n">width</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># Bytes per line (3 channels)</span>
                        <span class="n">QImage</span><span class="o">.</span><span class="n">Format</span><span class="o">.</span><span class="n">Format_RGB888</span>
                    <span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">qimg</span><span class="o">.</span><span class="n">isNull</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Failed to create QImage from image data&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># Create and set pixmap</span>
                    <span class="n">pixmap</span> <span class="o">=</span> <span class="n">QPixmap</span><span class="o">.</span><span class="n">fromImage</span><span class="p">(</span><span class="n">qimg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pixmap</span><span class="o">.</span><span class="n">isNull</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Failed to create QPixmap from QImage&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># Scale the pixmap to fit the preview widget while maintaining aspect ratio</span>
                    <span class="n">scaled_pixmap</span> <span class="o">=</span> <span class="n">pixmap</span><span class="o">.</span><span class="n">scaled</span><span class="p">(</span>
                        <span class="n">preview_widget</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span>
                        <span class="n">Qt</span><span class="o">.</span><span class="n">AspectRatioMode</span><span class="o">.</span><span class="n">KeepAspectRatio</span><span class="p">,</span>
                        <span class="n">Qt</span><span class="o">.</span><span class="n">TransformationMode</span><span class="o">.</span><span class="n">SmoothTransformation</span>
                    <span class="p">)</span>
                    
                    <span class="n">preview_widget</span><span class="o">.</span><span class="n">setPixmap</span><span class="p">(</span><span class="n">scaled_pixmap</span><span class="p">)</span>
                    <span class="n">preview_widget</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignmentFlag</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
                    <span class="n">path_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">image_path</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully loaded preview for </span><span class="si">{</span><span class="n">image_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        
            <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">img_error</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading image </span><span class="si">{</span><span class="n">image_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">img_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported or corrupted image: </span><span class="si">{</span><span class="n">image_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">img_error</span>
                
        <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">path_label</span><span class="p">,</span> <span class="s1">&#39;setText&#39;</span><span class="p">):</span>
                <span class="n">path_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">preview_widget</span><span class="p">,</span> <span class="s1">&#39;clear&#39;</span><span class="p">):</span>
                <span class="n">preview_widget</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            
        <span class="k">except</span> <span class="ne">PermissionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Permission denied: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">path_label</span><span class="p">,</span> <span class="s1">&#39;setText&#39;</span><span class="p">):</span>
                <span class="n">path_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error loading preview: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">path_label</span><span class="p">,</span> <span class="s1">&#39;setText&#39;</span><span class="p">):</span>
                <span class="n">path_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Error: Could not load preview&quot;</span><span class="p">)</span>
                
            <span class="c1"># Clear the preview widget</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">preview_widget</span><span class="p">,</span> <span class="s1">&#39;clear&#39;</span><span class="p">):</span>
                <span class="n">preview_widget</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">preview_widget</span><span class="p">,</span> <span class="s1">&#39;setText&#39;</span><span class="p">):</span>
                <span class="n">preview_widget</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Preview not available&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="UI.get_theme_stylesheet">
<a class="viewcode-back" href="../../api.html#script.UI.UI.get_theme_stylesheet">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_theme_stylesheet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the stylesheet for the current theme.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        /* Progress bar */</span>
<span class="s2">        QProgressBar {</span>
<span class="s2">            border: 1px solid #3a3a3a;</span>
<span class="s2">            border-radius: 4px;</span>
<span class="s2">            background-color: #2d2d2d;</span>
<span class="s2">            text-align: center;</span>
<span class="s2">            height: 12px;</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        QProgressBar::chunk {</span>
<span class="s2">            background-color: #4CAF50;</span>
<span class="s2">            border-radius: 2px;</span>
<span class="s2">            width: 10px;</span>
<span class="s2">            margin: 0.5px;</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        QProgressBar:disabled {</span>
<span class="s2">            background-color: #2a2a2a;</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        QProgressBar::chunk:disabled {</span>
<span class="s2">            background-color: #2e7d32;</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        /* Progress label */</span>
<span class="s2">        QLabel#progressLabel {</span>
<span class="s2">            color: #aaaaaa;</span>
<span class="s2">            font-size: 11px;</span>
<span class="s2">            padding: 2px 0;</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Nsfr750.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>